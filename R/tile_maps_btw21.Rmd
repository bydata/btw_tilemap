---
title: "Ergebnisse Bundestagswahl 2021" 
description: ""
author:
    - name: "Cédric Scherer"
      url: https://cedricscherer.com
    - name: "Ansgar Wolsing"
      url: 
date: "`r Sys.Date()`"
output: 
    distill::distill_article:
        highlight: kate
        code_folding: false  
        toc: true            
        toc_depth: 2         
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,
                      fig.width = 10, fig.height = 11.7, 
                      dev = "ragg_png", res = 1000, retina = 1)
```

# Setup

```{r prep}
pacman::p_load("tidyverse", "here", "glue", "colorspace", "sf", "geojson", "pdftools")
```


# Daten

## Tile Grid Map

```{r grid-constituencies}
grid <- read_csv(here("data", "de_constituencies_grid.csv")) %>% 
  mutate(id_num = as.numeric(id))
```


## Ergebnisse Bundestagswahl 2021

Source: 

```{r data-btw21}
btw_raw <- read_csv(here("data", "btw21_DieZeit.csv"))

btw_clean <- btw_raw %>% 
  mutate(
    winner_de = case_when(
      party == "CDU" ~ "CDU",
      party == "SPD" ~ "SPD",
      party == "Grüne" ~ "Bündnis 90/Die Grünen",
      party == "FDP" ~ "FDP",
      party == "AfD" ~ "AfD",
      party == "Linke" ~ "Die Linke",
      party == "CSU" ~ "CSU",
      TRUE ~ "Andere"
    ),
    winner_en = case_when(
      party == "Grüne" ~ "Alliance 90/The Greens",
      party == "Linke" ~ "The Left",
      winner_de == "Andere" ~ "Other",
      TRUE ~ winner_de
    ),
    winner_de = factor(winner_de, levels = c("SPD", "CDU", "CSU", "Bündnis 90/Die Grünen", 
                                              "FDP", "AfD", "Die Linke", "Andere")),
    winner_en = factor(winner_en, levels = c("SPD", "CDU", "CSU", "Alliance 90/The Greens", 
                                              "FDP", "AfD", "The Left", "Other"))
  )
```

```{r data-btw21-first-vote}
btw_first <- 
  btw_clean %>% 
  group_by(electoral_id) %>%
  arrange(-first_percent, -first_absolute) %>% 
  slice(1:2) %>% 
  mutate(rank = row_number()) %>% 
  dplyr::select(electoral_id, first_percent, winner_de, winner_en, rank) %>% 
  pivot_wider(
    id_cols = c(electoral_id),
    names_from = rank,
    values_from = c(first_percent, winner_de, winner_en)
  ) %>% 
  mutate(
    winner_first_de = winner_de_1,
    winner_first_en = winner_en_1,
    follow_first_de = winner_de_2,
    follow_first_en = winner_en_2,
    winner_first_percent = first_percent_1,
    follow_first_percent = first_percent_2,
    difference_first_percent = first_percent_1 - first_percent_2
  ) %>% 
  dplyr::select(-ends_with("_1"), -ends_with("_2"))
```

```{r data-btw21-second-vote}
btw_second <- 
  btw_clean %>% 
  group_by(electoral_id) %>%
  arrange(-second_percent, -second_absolute) %>% 
  slice(1:2) %>% 
  mutate(rank = row_number()) %>% 
  dplyr::select(electoral_id, second_percent, winner_de, winner_en, rank) %>% 
  pivot_wider(
    id_cols = c(electoral_id),
    names_from = rank,
    values_from = c(second_percent, winner_de, winner_en)
  ) %>% 
  mutate(
    winner_second_de = winner_de_1,
    winner_second_en = winner_en_1,
    follow_second_de = winner_de_2,
    follow_second_en = winner_en_2,
    winner_second_percent = second_percent_1,
    follow_second_percent = second_percent_2,
    difference_second_percent = second_percent_1 - second_percent_2
  ) %>% 
  dplyr::select(-ends_with("_1"), -ends_with("_2"))
```

## Kombinierte Datensätze

```{r data-join}
grid_btw <- 
  grid %>% 
  left_join(btw_first, by = c("id_num" = "electoral_id")) %>% 
  left_join(btw_second, by = c("id_num" = "electoral_id"))
```


# Setup Tile Maps

```{r}
theme_set(theme_void(base_family = "Noto Serif")) #Editorial New, Noto Serif
theme_update(legend.margin = margin(0, 10, 0, 25),
             legend.title = element_text(size = 16, margin = margin(15, 0, 1, 0),
                                         family = "Chivo", face = "bold"),
             legend.text = element_text(size = 16, margin = margin(5, 0, 5, -2.5),
                                        family = "Chivo"),
             plot.title = element_text(hjust = .5, face = "bold", size = 28,
                                       lineheight = 1.1, margin = margin(t = 10, b = 20)),
             plot.subtitle = element_text(hjust = .5, color = "grey33", size = 16,
                                          margin = margin(t = -15, b = 18)),
             plot.title.position = "plot",
             plot.caption = element_text(hjust = 0, color = "grey33", 
                                         lineheight = 1.3,
                                         size = 12, margin = margin(20, 0, 5, 5)),
             plot.caption.position = "plot",
             plot.margin = margin(10, 0, 10, 0))

# Party colors
party_colors <- c("SPD" = "#ca0002", ##"#E3000F",  a bit darker now to make it work better with CVD
                  "CDU" = "#212121", 
                  "CSU" = "#4e4e6d", ## grey33, #464662
                  "Bündnis 90/Die Grünen" = rgb(100, 161, 45, maxColorValue = 255),
                  "FDP" = darken("#ffed00", 0.1),
                  "AfD" = rgb(0, 158, 224, maxColorValue = 255),
                  "Die Linke" = "purple",
                  "Andere" = "grey74")

party_colors_first <- party_colors[c(1, 2, 3, 4, 6, 7)]
party_colors_second <- party_colors[c(1, 2, 3, 4, 6)]

parties_first_en <- c("SPD", "CDU", "CSU", "Alliance 90/The Greens", "AfD", "The Left")
parties_second_en <- c("SPD", "CDU", "CSU", "Alliance 90/The Greens", "AfD")

title_de <- "Ergebnisse der Bundestagswahl 2021"
title_en <- "Results of the German National Election 2021"

caption_de <- "Grafik: Cédric Scherer & Ansgar Wolsing • Daten: DIE ZEIT"
caption_en <- "Graphic: Cédric Scherer & Ansgar Wolsing • Source: DIE ZEIT"
```

# Erststimme

```{r basic-plot-erststimme}
g <-  
  ggplot(grid_btw, aes(col, row)) +
  coord_fixed() +
  scale_x_continuous(limits = c(-.5, max(grid$col) + 4)) +
  scale_y_reverse(expand = c(.03, .03)) +
  scale_color_manual(values = party_colors_first, name = NULL) +
  scale_fill_manual(values = party_colors_first, name = NULL) +
  guides(color = guide_legend(override.aes = list(size = 6)),
         fill = guide_legend(override.aes = list(size = 6))) +
  theme(legend.position = c(.82, .27))
```


## Erststimme — Gewinner

```{r titles-winner-erststimme}
subtitle_first_de <- "Die stärksten Parteien nach Erststimmen."
subtitle_first_en <- "The winner parties by first votes."
```

### Tile Grid Map

```{r tile-grid-map-erststimme}
g_tile_winner <- g +
  geom_point(
    aes(color = winner_first_de), 
    size = 11, shape = 15
  ) 

## Deutsche Version
g_tile_winner + labs(title = title_de, subtitle = subtitle_first_de, caption = caption_de)

ggsave(here::here("plots", "btw21", "first-votes", "btw21_tile_grid_map_first_winner_de.pdf"), width = 10, height = 11.7, device = cairo_pdf)

## Englische Version
g_tile_winner + labs(title = title_en, subtitle = subtitle_first_en, caption = caption_en) +
  scale_fill_manual(values = party_colors_first, name = NULL, labels = parties_first_en)

ggsave(here::here("plots", "btw21", "first-votes", "btw21_tile_grid_map_first_winner_en.pdf"), width = 10, height = 11.7, device = cairo_pdf)
```

### mit Wahlkreisnummern

```{r tile-grid-map-erststimme-wk}
g_tile_winner_id <- g_tile_winner +
  geom_text(
    aes(label = id, color = winner_first_de, 
        color = after_scale(lighten(color, .35))),
    size = 3.2, family = "Chivo", fontface = "bold",
    show.legend = FALSE
  )
  # geom_text(
  #   aes(label = id),
  #   size = 3.2, family = "Chivo", 
  #   color = "#fefefe", fontface = "bold"
  # )

## Deutsche Version
g_tile_winner_id + labs(title = title_de, subtitle = subtitle_first_de, caption = caption_de)

ggsave(here::here("plots", "btw21", "first-votes", "btw21_tile_grid_map_first_winner_de_id.pdf"), width = 10, height = 11.7, device = cairo_pdf)

## Englische Version
g_tile_winner_id + labs(title = title_en, subtitle = subtitle_first_en, caption = caption_en) +
  scale_color_manual(values = party_colors_first, name = NULL, labels = parties_first_en)

ggsave(here::here("plots", "btw21", "first-votes", "btw21_tile_grid_map_first_winner_en_id.pdf"), width = 10, height = 11.7, device = cairo_pdf)
```

## Dot Map

```{r dot-grid-map-erststimme}
g_dot_winner <- g +
  geom_point(aes(color = winner_first_de), size = 10) 

## Deutsche Version
g_dot_winner + labs(title = title_de, subtitle = subtitle_first_de, caption = caption_de)

ggsave(here::here("plots", "btw21", "first-votes", "btw21_dot_grid_map_first_winner_de.pdf"), width = 10, height = 11.7, device = cairo_pdf)

## Englische Version
g_dot_winner + labs(title = title_en, subtitle = subtitle_first_en, caption = caption_en) +
  scale_color_manual(values = party_colors_first,
                     name = NULL, labels = parties_first_en)

ggsave(here::here("plots", "btw21", "first-votes", "btw21_dot_grid_map_first_winner_en.pdf"), width = 10, height = 11.7, device = cairo_pdf)
```

### mit Wahlkreisnummern

```{r dot-grid-map-erststimme-wk}
g_dot_winner_id <- g_dot_winner +
  geom_text(
    aes(label = id, color = winner_first_de, 
        color = after_scale(lighten(color, .35))),
    size = 3.1, family = "Chivo", fontface = "bold",
    show.legend = FALSE
  )

## Deutsche Version
g_dot_winner_id + labs(title = title_de, subtitle = subtitle_first_de, caption = caption_de)

ggsave(here::here("plots", "btw21", "first-votes", "btw21_dot_grid_map_first_winner_de_id.pdf"), width = 10, height = 11.7, device = cairo_pdf)

## Englische Version
g_dot_winner_id + labs(title = title_en, subtitle = subtitle_first_en, caption = caption_en) +
  scale_color_manual(values = party_colors_first, name = NULL, labels = parties_first_en)

ggsave(here::here("plots", "btw21", "first-votes", "btw21_dot_grid_map_first_winner_en_id.pdf"), width = 10, height = 11.7, device = cairo_pdf)
```


### Variante mit gedämpfteren Farben für die Füllung der Punkte

```{r dot-grid-map-erststimme-light}
g_dot_winner_light <- g +
  geom_point(
    aes(fill = winner_first_de), 
    size = 8.6, shape = 21, stroke = 1.4, alpha = .5, color = "transparent"
  ) +
  geom_point(
    aes(color = winner_first_de), 
    size = 8.6, shape = 21, stroke = 1.4, fill = "transparent"
  ) +
  guides(color = guide_legend(override.aes = list(size = 5.5)))

## Deutsche Version
g_dot_winner_light + labs(title = title_de, subtitle = subtitle_first_de, caption = caption_de)

ggsave(here::here("plots", "btw21", "first-votes", "btw21_dot_grid_map_first_winner_de_light.pdf"), width = 10, height = 11.7, device = cairo_pdf)
 
## Englische Version
g_dot_winner_light + labs(title = title_en, subtitle = subtitle_first_en, caption = caption_en) +
  scale_color_manual(values =party_colors_first,
                     name = NULL, labels = parties_first_en) +
  scale_fill_manual(values = party_colors_first,
                    name = NULL, labels = parties_first_en)

ggsave(here::here("plots", "btw21", "first-votes", "btw21_dot_grid_map_first_winner_en_light.pdf"), width = 10, height = 11.7, device = cairo_pdf)
```



## Hexagon Tiles

```{r hexagon-tiles}
## READ GEOMETRY ==============================================
#' https://pitchinteractiveinc.github.io/tilegrams/
#' Download geometry "Germany - Constituencies" as TopoJSON
#' and place it in the data directory
filepath_topo <- here("data", "tiles.topo.json")
wk_topo <- geojsonio::topojson_read(filepath_topo)
wk_topo <- wk_topo %>% mutate(id = as.numeric(id))

# Merge shapes of constituencies into state-level shapes 
bland_shape <- wk_topo %>% 
  inner_join(grid_btw, by = c("id" = "id_num")) %>% 
  group_by(bundesland_de) %>% 
  summarize(geometry = st_union(geometry))
```


### Hexbin Map

```{r hexbin-map-erststimme}
g_hex <- grid_btw %>% 
  inner_join(wk_topo, by = c("id_num" = "id")) %>% 
  ggplot(aes(geometry = geometry)) +
  geom_sf(
    aes(fill = winner_first_de),
    size = .3, col = "grey85"
  ) +
  geom_sf_text(
    aes(label = id, color = winner_first_de, 
        color = after_scale(lighten(color, .35))),
    size = 3.2, family = "Chivo", fontface = "bold",
    show.legend = FALSE
  ) +
  geom_sf(
    data = bland_shape,
    aes(geometry = geometry, 
        group = bundesland_de),
    fill = NA, col = "#fefefe",
    size = 2.3, show.legend = FALSE
  ) +
  geom_sf(
    aes(fill = winner_first_de),
    size = .5, fill = NA, col = "grey85",
  ) +
  scale_x_continuous(expand = c(.1, .1)) +
  scale_y_continuous(expand = c(.01, .01)) +
  scale_color_manual(values = party_colors_first, guide = "none") +
  scale_fill_manual(values = party_colors_first, name = NULL) +
  guides(fill = guide_legend(override.aes = list(size = 0.25))) +
  theme(legend.position = c(.16, .92),
        legend.key.size = unit(5, "mm"))

## Deutsche Version
g_hex + 
  labs(title = title_de, subtitle = subtitle_first_de,
       caption = glue("{caption_de}\nTilegram-Geometrie: pitchinteractiveinc.github.io"))

ggsave(here("plots", "btw21", "first-votes", "btw21_hexagon_map_first_winner_de_id.pdf"), width = 10, height = 11.7, device = cairo_pdf)

## Englische Version
g_hex + 
  labs(title = title_en, subtitle = subtitle_first_en,
       caption = glue("{caption_en}\nTilegram-Geometrie: pitchinteractiveinc.github.io")) +
  scale_fill_manual(values = party_colors_first,
                    name = NULL, labels = parties_first_en)

ggsave(here("plots", "btw21", "first-votes", "btw21_hexagon_map_first_winner_en_id.pdf"), width = 10, height = 11.7, device = cairo_pdf)
``` 


## Erststimme — Vorsprung

### Tile Grid Map

```{r titles-lead-first}
subtitle_first_diff_de <- "Die stärksten Parteien nach Erststimmen und Vorsprung zur zweitplatzierten Partei."
subtitle_first_diff_en <- "The winner parties by first votes and lead over the second-placed party."
```


```{r tile-grid-map-erststimme-vorsprung}
g_tile_diff <- g +
  geom_point(
    aes(color = winner_first_de, alpha = difference_first_percent), 
    size = 11, shape = 15
  ) +
  scale_x_continuous(limits = c(-.5, max(grid$col) + 4.5)) +
  scale_alpha(range = c(.25, 1), name = "Vorsprung:", labels = scales::percent_format(scale = 1)) +
  guides(color = guide_legend(override.aes = list(size = 8, alpha = .7), order = 1),
         alpha = guide_legend(override.aes = list(size = 8), order = 2)) +
  theme(legend.position = c(.83, .2))

## Deutsche Version
g_tile_diff + labs(title = title_de, subtitle = subtitle_first_diff_de, caption = caption_de)

ggsave(here::here("plots", "btw21", "first-votes", "btw21_tile_grid_map_first_diff_de.pdf"), width = 10, height = 11.3, device = cairo_pdf)

## Englische Version
g_tile_diff + labs(title = title_en, subtitle = subtitle_first_diff_en, caption = caption_en) +
  scale_color_manual(values = party_colors_first, name = NULL, labels = parties_first_en) +
  scale_alpha(range = c(.25, 1), name = "Lead:", labels = scales::percent_format(scale = 1))

ggsave(here::here("plots", "btw21", "first-votes", "btw21_tile_grid_map_first_diff_en.pdf"), width = 10, height = 11.3, device = cairo_pdf)
```

### mit Wahlkreisnummern

```{r tile-grid-map-erststimme-vorsprung-wk}
g_tile_diff_id <- g_tile_diff +
  geom_text(
    data = filter(grid_btw, difference_first_percent > 15),
    aes(label = id, color = winner_first_de,
        color = after_scale(lighten(color, .65))),
    size = 3.2, family = "Chivo", fontface = "bold", 
    show.legend = FALSE
  ) +
  geom_text(
    data = filter(grid_btw, difference_first_percent <= 15),
    aes(label = id, color = winner_first_de,
        color = after_scale(darken(color, .35))),
    size = 3.2, family = "Chivo", fontface = "bold", 
    show.legend = FALSE
  )

## Deutsche Version
g_tile_diff_id + 
  labs(title = title_de, subtitle = subtitle_first_diff_de, caption = caption_de)

ggsave(here::here("plots", "btw21", "first-votes", "btw21_tile_grid_map_first_diff_de_id.pdf"), width = 10, height = 11.7, device = cairo_pdf)

## Englische Version
g_tile_diff_id + 
  labs(title = title_en, subtitle = subtitle_first_diff_en, caption = caption_en) +
  scale_fill_manual(values = party_colors_first, name = NULL, labels = parties_first_en) +
  scale_alpha(range = c(.25, 1), name = "Lead:", labels = scales::percent_format(scale = 1))

ggsave(here::here("plots", "btw21", "first-votes", "btw21_tile_grid_map_first_diff_en_id.pdf"), width = 10, height = 11.7, device = cairo_pdf)
```

## Dot Map

```{r dot-grid-map-erststimme-vorsprung}
g_dot_diff <- g +
  geom_point(
    aes(color = winner_first_de, alpha = difference_first_percent), 
    size = 8.6, shape = 16
  ) +
  geom_point(
    aes(color = winner_first_de), 
    size = 8.6, shape = 21, stroke = 1.4, fill = "transparent", show.legend = FALSE
  ) +
  scale_alpha(range = c(.25, .85), name = "Vorsprung:", labels = scales::percent_format(scale = 1)) +
  guides(color = guide_legend(override.aes = list(size = 6, alpha = .7), order = 1),
         alpha = guide_legend(override.aes = list(size = 6), order = 2)) +
  theme(legend.position = c(.83, .2))

## Deutsche Version
g_dot_diff + 
  labs(title = title_de, subtitle = subtitle_first_diff_de, caption = caption_de)

ggsave(here::here("plots", "btw21", "first-votes", "btw21_dot_grid_map_first_diff_de.pdf"), width = 10, height = 11.7, device = cairo_pdf)

## Englische Version
g_dot_diff + 
  labs(title = title_en, subtitle = subtitle_first_diff_en, caption = caption_en) +
  scale_fill_manual(values = party_colors_first,
                    name = NULL, labels = parties_first_en) +
  scale_alpha(range = c(.25, .85), name = "Vorsprung:", labels = scales::percent_format(scale = 1)) 

ggsave(here::here("plots", "btw21", "first-votes", "btw21_dot_grid_map_first_diff_en.pdf"), width = 10, height = 11.7, device = cairo_pdf)
```

### mit Wahlkreisnummern

```{r dot-grid-map-erststimme-diff-wk}
g_dot_diff_id <- g_dot_diff +
  geom_text(
    data = filter(grid_btw, difference_first_percent > 15),
    aes(label = id, color = winner_first_de,
        color = after_scale(lighten(color, .65))),
    size = 2.8, family = "Chivo", fontface = "bold", 
    show.legend = FALSE
  ) +
  geom_text(
    data = filter(grid_btw, difference_first_percent <= 15),
    aes(label = id, color = winner_first_de,
        color = after_scale(darken(color, .35))),
    size = 2.8, family = "Chivo", fontface = "bold", 
    show.legend = FALSE
  )

## Deutsche Version
g_dot_diff_id + 
  labs(title = title_de, subtitle = subtitle_first_diff_de, caption = caption_de)

ggsave(here::here("plots", "btw21", "first-votes", "btw21_dot_grid_map_first_diff_de_id.pdf"), width = 10, height = 12, device = cairo_pdf)

## Englische Version
g_dot_diff_id + 
  labs(title = title_en, subtitle = subtitle_first_diff_en, caption = caption_en) +
  scale_fill_manual(values = party_colors_first, name = NULL, labels = parties_first_en)

ggsave(here::here("plots", "btw21", "first-votes", "btw21_dot_grid_map_first_diff_en_id.pdf"), width = 10, height = 12, device = cairo_pdf)
```


## Erststimme — Votes

### Tile Grid Map

```{r titles-votes-erststimme}
subtitle_first_votes_de <- "Die stärksten Parteien nach Prozent der Erststimmen."
subtitle_first_votes_en <- "The winner parties by percentage of first votes."
```


```{r tile-grid-map-erststimme-votes}
g_tile_diff <- g +
  geom_point(
    aes(color = winner_first_de, alpha = winner_first_percent), 
    size = 11, shape = 15
  ) +
  scale_x_continuous(limits = c(-.5, max(grid$col) + 4.5)) +
  scale_alpha(range = c(.25, 1), name = "Erststimmen:", labels = scales::percent_format(scale = 1)) +
  guides(color = guide_legend(override.aes = list(size = 8, alpha = .7), order = 1),
         alpha = guide_legend(override.aes = list(size = 8), order = 2)) +
  theme(legend.position = c(.83, .2))

## Deutsche Version
g_tile_diff + labs(title = title_de, subtitle = subtitle_first_votes_de, caption = caption_de)

ggsave(here::here("plots", "btw21", "first-votes", "btw21_tile_grid_map_first_votes_de.pdf"), width = 10, height = 11.3, device = cairo_pdf)

## Englische Version
g_tile_diff + labs(title = title_en, subtitle = subtitle_first_votes_en, caption = caption_en) +
  scale_color_manual(values = party_colors_first, name = NULL, labels = parties_first_en) +
  scale_alpha(range = c(.25, 1), name = "Lead:", labels = scales::percent_format(scale = 1))

ggsave(here::here("plots", "btw21", "first-votes", "btw21_tile_grid_map_first_votes_en.pdf"), width = 10, height = 11.3, device = cairo_pdf)
```

### mit Wahlkreisnummern

```{r tile-grid-map-erststimme-votes-wk}
g_tile_diff_id <- g_tile_diff +
  geom_text(
    data = filter(grid_btw, winner_first_percent > 15),
    aes(label = id, color = winner_first_de,
        color = after_scale(lighten(color, .65))),
    size = 3.2, family = "Chivo", fontface = "bold", 
    show.legend = FALSE
  ) +
  geom_text(
    data = filter(grid_btw, winner_first_percent <= 15),
    aes(label = id, color = winner_first_de,
        color = after_scale(darken(color, .35))),
    size = 3.2, family = "Chivo", fontface = "bold", 
    show.legend = FALSE
  )

## Deutsche Version
g_tile_diff_id + 
  labs(title = title_de, subtitle = subtitle_first_votes_de, caption = caption_de)

ggsave(here::here("plots", "btw21", "first-votes", "btw21_tile_grid_map_first_votes_de_id.pdf"), width = 10, height = 11.7, device = cairo_pdf)

## Englische Version
g_tile_diff_id + 
  labs(title = title_en, subtitle = subtitle_first_votes_en, caption = caption_en) +
  scale_fill_manual(values = party_colors_first, name = NULL, labels = parties_first_en) +
  scale_alpha(range = c(.25, 1), name = "Lead:", labels = scales::percent_format(scale = 1))

ggsave(here::here("plots", "btw21", "first-votes", "btw21_tile_grid_map_first_votes_en_id.pdf"), width = 10, height = 11.7, device = cairo_pdf)
```

## Dot Map

```{r dot-grid-map-erststimme-votes}
g_dot_diff <- g +
  geom_point(
    aes(color = winner_first_de, alpha = winner_first_percent), 
    size = 8.6, shape = 16
  ) +
  geom_point(
    aes(color = winner_first_de), 
    size = 8.6, shape = 21, stroke = 1.4, fill = "transparent", show.legend = FALSE
  ) +
  scale_alpha(range = c(.25, .85), name = "Erststimmen:", labels = scales::percent_format(scale = 1)) +
  guides(color = guide_legend(override.aes = list(size = 6, alpha = .7), order = 1),
         alpha = guide_legend(override.aes = list(size = 6), order = 2)) +
  theme(legend.position = c(.83, .2))

## Deutsche Version
g_dot_diff + 
  labs(title = title_de, subtitle = subtitle_first_votes_de, caption = caption_de)

ggsave(here::here("plots", "btw21", "first-votes", "btw21_dot_grid_map_first_votes_de.pdf"), width = 10, height = 11.7, device = cairo_pdf)

## Englische Version
g_dot_diff + 
  labs(title = title_en, subtitle = subtitle_first_votes_en, caption = caption_en) +
  scale_fill_manual(values = party_colors_first,
                    name = NULL, labels = parties_first_en) +
  scale_alpha(range = c(.25, .85), name = "Erststimmen:", labels = scales::percent_format(scale = 1)) 

ggsave(here::here("plots", "btw21", "first-votes", "btw21_dot_grid_map_first_votes_en.pdf"), width = 10, height = 11.7, device = cairo_pdf)
```

### mit Wahlkreisnummern

```{r dot-grid-map-erststimme-votes-wk}
g_dot_diff_id <- g_dot_diff +
  geom_text(
    data = filter(grid_btw, winner_first_percent > 15),
    aes(label = id, color = winner_first_de,
        color = after_scale(lighten(color, .65))),
    size = 2.8, family = "Chivo", fontface = "bold", 
    show.legend = FALSE
  ) +
  geom_text(
    data = filter(grid_btw, winner_first_percent <= 15),
    aes(label = id, color = winner_first_de,
        color = after_scale(darken(color, .35))),
    size = 2.8, family = "Chivo", fontface = "bold", 
    show.legend = FALSE
  )

## Deutsche Version
g_dot_diff_id + 
  labs(title = title_de, subtitle = subtitle_first_votes_de, caption = caption_de)

ggsave(here::here("plots", "btw21", "first-votes", "btw21_dot_grid_map_first_votes_de_id.pdf"), width = 10, height = 11.7, device = cairo_pdf)

## Englische Version
g_dot_diff_id + 
  labs(title = title_en, subtitle = subtitle_first_votes_en, caption = caption_en) +
  scale_fill_manual(values = party_colors_first, name = NULL, labels = parties_first_en)

ggsave(here::here("plots", "btw21", "first-votes", "btw21_dot_grid_map_first_votes_en_id.pdf"), width = 10, height = 11.7, device = cairo_pdf)
```




# Zweitstimme

```{r basic-plot-zweitstimme}
g <-  
  ggplot(grid_btw, aes(col, row)) +
  coord_fixed() +
  scale_x_continuous(limits = c(-.5, max(grid$col) + 4)) +
  scale_y_reverse(expand = c(.03, .03)) +
  scale_color_manual(values = party_colors_second, name = NULL) +
  scale_fill_manual(values = party_colors_second, name = NULL) +
  guides(color = guide_legend(override.aes = list(size = 6)),
         fill = guide_legend(override.aes = list(size = 6))) +
  theme(legend.position = c(.82, .27))
```

## Zweitstimme — Gewinner

```{r titles-winner-first}
subtitle_second_de <- "Die stärksten Parteien nach Zweitstimmen."
subtitle_second_en <- "The winner parties by second votes."
```

### Tile Grid Map

```{r tile-grid-map-zweitstimme}
g_tile_winner <- g +
  geom_point(
    aes(color = winner_second_de), 
    size = 11, shape = 15
  ) 

## Deutsche Version
g_tile_winner + labs(title = title_de, subtitle = subtitle_second_de, caption = caption_de)

ggsave(here::here("plots", "btw21", "second-votes", "btw21_tile_grid_map_second_winner_de.pdf"), width = 10, height = 11.7, device = cairo_pdf)

## Englische Version
g_tile_winner + labs(title = title_en, subtitle = subtitle_second_en, caption = caption_en) +
  scale_color_manual(values = party_colors_second, name = NULL, labels = parties_second_en)

ggsave(here::here("plots", "btw21", "second-votes", "btw21_tile_grid_map_second_winner_en.pdf"), width = 10, height = 11.7, device = cairo_pdf)
```


```{r tile-grid-map-zweitstimme-true-tiles}
g_true_tile_winner <- g +
  geom_tile(
    aes(fill = winner_second_de, color = after_scale(fill)), 
    size = 0
  ) 

## Deutsche Version
g_true_tile_winner + labs(title = title_de, subtitle = subtitle_second_de, caption = caption_de)

ggsave(here::here("plots", "btw21", "second-votes", "btw21_tile_grid_map_second_winner_de_true.pdf"), width = 10, height = 11.7, device = cairo_pdf)

## Englische Version
g_true_tile_winner + labs(title = title_en, subtitle = subtitle_second_en, caption = caption_en) +
  scale_fill_manual(values = party_colors_second, name = NULL, labels = parties_second_en) +
  scale_color_manual(values = party_colors_second, name = NULL, labels = parties_second_en)

ggsave(here::here("plots", "btw21", "second-votes", "btw21_tile_grid_map_second_winner_en_true.pdf"), width = 10, height = 11.7, device = cairo_pdf)
```

### mit Wahlkreisnummern

```{r tile-grid-map-zweitstimme-wk}
g_tile_winner_id <- g_tile_winner +
  geom_text(
    aes(label = id, color = winner_second_de, 
        color = after_scale(lighten(color, .35))),
    size = 3.2, family = "Chivo", fontface = "bold",
    show.legend = FALSE
  )
  # geom_text(
  #   aes(label = id),
  #   size = 3.2, family = "Chivo", 
  #   color = "#fefefe", fontface = "bold"
  # )

## Deutsche Version
g_tile_winner_id + labs(title = title_de, subtitle = subtitle_second_de, caption = caption_de)

ggsave(here::here("plots", "btw21", "second-votes", "btw21_tile_grid_map_second_winner_de_id.pdf"), width = 10, height = 11.7, device = cairo_pdf)

## Englische Version
g_tile_winner_id + labs(title = title_en, subtitle = subtitle_second_en, caption = caption_en) +
  scale_color_manual(values = party_colors_second, name = NULL, labels = parties_second_en)

ggsave(here::here("plots", "btw21", "second-votes", "btw21_tile_grid_map_second_winner_en_id.pdf"), width = 10, height = 11.7, device = cairo_pdf)
```

## Dot Map

```{r dot-grid-map-zweitstimme}
g_dot_winner <- g +
  geom_point(aes(color = winner_second_de), size = 10) 

## Deutsche Version
g_dot_winner + labs(title = title_de, subtitle = subtitle_second_de, caption = caption_de)

ggsave(here::here("plots", "btw21", "second-votes", "btw21_dot_grid_map_second_winner_de.pdf"), width = 10, height = 11.7, device = cairo_pdf)

## Englische Version
g_dot_winner + labs(title = title_en, subtitle = subtitle_second_en, caption = caption_en) +
  scale_color_manual(values = party_colors_second,
                     name = NULL, labels = parties_second_en)

ggsave(here::here("plots", "btw21", "second-votes", "btw21_dot_grid_map_second_winner_en.pdf"), width = 10, height = 11.7, device = cairo_pdf)
```

### mit Wahlkreisnummern

```{r dot-grid-map-zweitstimme-wk}
g_dot_winner_id <- g_dot_winner +
  geom_text(
    aes(label = id, color = winner_second_de, 
        color = after_scale(lighten(color, .35))),
    size = 3.1, family = "Chivo", fontface = "bold",
    show.legend = FALSE
  )

## Deutsche Version
g_dot_winner_id + labs(title = title_de, subtitle = subtitle_second_de, caption = caption_de)

ggsave(here::here("plots", "btw21", "second-votes", "btw21_dot_grid_map_second_winner_de_id.pdf"), width = 10, height = 11.7, device = cairo_pdf)

## Englische Version
g_dot_winner_id + labs(title = title_en, subtitle = subtitle_second_en, caption = caption_en) +
  scale_color_manual(values = party_colors_second, name = NULL, labels = parties_second_en)

ggsave(here::here("plots", "btw21", "second-votes", "btw21_dot_grid_map_second_winner_en_id.pdf"), width = 10, height = 11.7, device = cairo_pdf)
```


### Variante mit gedämpfteren Farben für die Füllung der Punkte

```{r dot-grid-map-zweitstimme-light}
g_dot_winner_light <- g +
  geom_point(
    aes(fill = winner_second_de), 
    size = 8.6, shape = 21, stroke = 1.4, alpha = .5, color = "transparent"
  ) +
  geom_point(
    aes(color = winner_second_de), 
    size = 8.6, shape = 21, stroke = 1.4, fill = "transparent"
  ) +
  guides(color = guide_legend(override.aes = list(size = 5.5)))

## Deutsche Version
g_dot_winner_light + labs(title = title_de, subtitle = subtitle_second_de, caption = caption_de)

ggsave(here::here("plots", "btw21", "second-votes", "btw21_dot_grid_map_second_winner_de_light.pdf"), width = 10, height = 11.7, device = cairo_pdf)
 
## Englische Version
g_dot_winner_light + labs(title = title_en, subtitle = subtitle_second_en, caption = caption_en) +
  scale_color_manual(values =party_colors_second,
                     name = NULL, labels = parties_second_en) +
  scale_fill_manual(values = party_colors_second,
                    name = NULL, labels = parties_second_en)

ggsave(here::here("plots", "btw21", "second-votes", "btw21_dot_grid_map_second_winner_en_light.pdf"), width = 10, height = 11.7, device = cairo_pdf)
```



## Hexagon Tiles

### Hexbin Map

```{r hexbon-map}
g_hex <- grid_btw %>% 
  inner_join(wk_topo, by = c("id_num" = "id")) %>% 
  ggplot(aes(geometry = geometry)) +
  geom_sf(
    aes(fill = winner_second_de),
    size = .3, col = "grey85"
  ) +
  geom_sf_text(
    aes(label = id, color = winner_second_de, 
        color = after_scale(lighten(color, .35))),
    size = 3.2, family = "Chivo", fontface = "bold",
    show.legend = FALSE
  ) +
  geom_sf(
    data = bland_shape,
    aes(geometry = geometry, 
        group = bundesland_de),
    fill = NA, col = "#fefefe",
    size = 2.3, show.legend = FALSE
  ) +
  geom_sf(
    aes(fill = winner_second_de),
    size = .5, fill = NA, col = "grey85",
  ) +
 scale_x_continuous(expand = c(.1, .1)) +
  scale_y_continuous(expand = c(.01, .01)) +
  scale_color_manual(values = party_colors_second, guide = "none") +
  scale_fill_manual(values = party_colors_second, name = NULL) +
  guides(fill = guide_legend(override.aes = list(size = 0.25))) +
  theme(legend.position = c(.16, .92),
        legend.key.size = unit(5, "mm"))

## Deutsche Version
g_hex + 
  labs(title = title_de, subtitle = subtitle_second_de,
       caption = glue("{caption_de}\nTilegram-Geometrie: pitchinteractiveinc.github.io"))

ggsave(here("plots", "btw21", "second-votes", "btw21_hexagon_map_second_winner_de_id.pdf"), width = 10, height = 11.7, device = cairo_pdf)

## Englische Version
g_hex + 
  labs(title = title_en, subtitle = subtitle_second_en,
       caption = glue("{caption_en}\nTilegram-Geometrie: pitchinteractiveinc.github.io")) +
  scale_fill_manual(values = party_colors_second,
                    name = NULL, labels = parties_second_en)

ggsave(here("plots", "btw21", "second-votes", "btw21_hexagon_map_second_winner_en_id.pdf"), width = 10, height = 11.7, device = cairo_pdf)
``` 


## Zweitstimme — Vorsprung

### Tile Grid Map

```{r titles-lead-zweitstimme}
subtitle_second_diff_de <- "Die stärksten Parteien nach Zweitstimmen und Vorsprung zur zweitplatzierten Partei."
subtitle_second_diff_en <- "The winner parties by second votes and lead over the second-placed party."
```


```{r tile-grid-map-zweitstimme-vorsprung}
g_tile_diff <- g +
  geom_point(
    aes(color = winner_second_de, alpha = difference_second_percent), 
    size = 11, shape = 15
  ) +
  scale_x_continuous(limits = c(-.5, max(grid$col) + 4.5)) +
  scale_alpha(range = c(.25, 1), name = "Vorsprung:", labels = scales::percent_format(scale = 1)) +
  guides(color = guide_legend(override.aes = list(size = 8, alpha = .7), order = 1),
         alpha = guide_legend(override.aes = list(size = 8), order = 2)) +
  theme(legend.position = c(.83, .2))

## Deutsche Version
g_tile_diff + labs(title = title_de, subtitle = subtitle_second_diff_de, caption = caption_de)

ggsave(here::here("plots", "btw21", "second-votes", "btw21_tile_grid_map_second_diff_de.pdf"), width = 10, height = 11.3, device = cairo_pdf)

## Englische Version
g_tile_diff + labs(title = title_en, subtitle = subtitle_second_diff_en, caption = caption_en) +
  scale_color_manual(values = party_colors_second, name = NULL, labels = parties_second_en) +
  scale_alpha(range = c(.25, 1), name = "Lead:", labels = scales::percent_format(scale = 1))

ggsave(here::here("plots", "btw21", "second-votes", "btw21_tile_grid_map_second_diff_en.pdf"), width = 10, height = 11.3, device = cairo_pdf)
```

### mit Wahlkreisnummern

```{r tile-grid-map-zweitstimme-vorsprung-wk}
g_tile_diff_id <- g_tile_diff +
  geom_text(
    data = filter(grid_btw, difference_second_percent > 13),
    aes(label = id, color = winner_second_de,
        color = after_scale(lighten(color, .65))),
    size = 3.2, family = "Chivo", fontface = "bold", 
    show.legend = FALSE
  ) +
  geom_text(
    data = filter(grid_btw, difference_second_percent <= 13),
    aes(label = id, color = winner_second_de,
        color = after_scale(darken(color, .35))),
    size = 3.2, family = "Chivo", fontface = "bold", 
    show.legend = FALSE
  )

## Deutsche Version
g_tile_diff_id + 
  labs(title = title_de, subtitle = subtitle_second_diff_de, caption = caption_de)

ggsave(here::here("plots", "btw21", "second-votes", "btw21_tile_grid_map_second_diff_de_id.pdf"), width = 10, height = 11.7, device = cairo_pdf)

## Englische Version
g_tile_diff_id + 
  labs(title = title_en, subtitle = subtitle_second_diff_en, caption = caption_en) +
  scale_fill_manual(values = party_colors_second, name = NULL, labels = parties_second_en) +
  scale_alpha(range = c(.25, 1), name = "Lead:", labels = scales::percent_format(scale = 1))

ggsave(here::here("plots", "btw21", "second-votes", "btw21_tile_grid_map_second_diff_en_id.pdf"), width = 10, height = 11.7, device = cairo_pdf)
```

## Dot Map

```{r dot-grid-map-zweitstimme-vorsprung}
g_dot_diff <- g +
  geom_point(
    aes(color = winner_second_de, alpha = difference_second_percent), 
    size = 8.6, shape = 16
  ) +
  geom_point(
    aes(color = winner_second_de), 
    size = 8.6, shape = 21, stroke = 1.4, fill = "transparent", show.legend = FALSE
  ) +
  scale_alpha(range = c(.25, .85), name = "Vorsprung:", labels = scales::percent_format(scale = 1)) +
  guides(color = guide_legend(override.aes = list(size = 6, alpha = .7), order = 1),
         alpha = guide_legend(override.aes = list(size = 6), order = 2)) +
  theme(legend.position = c(.83, .2))

## Deutsche Version
g_dot_diff + 
  labs(title = title_de, subtitle = subtitle_second_diff_de, caption = caption_de)

ggsave(here::here("plots", "btw21", "second-votes", "btw21_dot_grid_map_second_diff_de.pdf"), width = 10, height = 11.7, device = cairo_pdf)

## Englische Version
g_dot_diff + 
  labs(title = title_en, subtitle = subtitle_second_diff_en, caption = caption_en) +
  scale_fill_manual(values = party_colors_second,
                    name = NULL, labels = parties_second_en) +
  scale_alpha(range = c(.25, .85), name = "Vorsprung:", labels = scales::percent_format(scale = 1)) 

ggsave(here::here("plots", "btw21", "second-votes", "btw21_dot_grid_map_second_diff_en.pdf"), width = 10, height = 11.7, device = cairo_pdf)
```

### mit Wahlkreisnummern

```{r dot-grid-map-zweitstimme-diff-wk}
g_dot_diff_id <- g_dot_diff +
  geom_text(
    data = filter(grid_btw, difference_second_percent > 12),
    aes(label = id, color = winner_second_de,
        color = after_scale(lighten(color, .65))),
    size = 2.8, family = "Chivo", fontface = "bold", 
    show.legend = FALSE
  ) +
  geom_text(
    data = filter(grid_btw, difference_second_percent <= 12),
    aes(label = id, color = winner_second_de,
        color = after_scale(darken(color, .35))),
    size = 2.8, family = "Chivo", fontface = "bold", 
    show.legend = FALSE
  )

## Deutsche Version
g_dot_diff_id + 
  labs(title = title_de, subtitle = subtitle_second_diff_de, caption = caption_de)

ggsave(here::here("plots", "btw21", "second-votes", "btw21_dot_grid_map_second_diff_de_id.pdf"), width = 10, height = 12, device = cairo_pdf)

## Englische Version
g_dot_diff_id + 
  labs(title = title_en, subtitle = subtitle_second_diff_en, caption = caption_en) +
  scale_fill_manual(values = party_colors_second, name = NULL, labels = parties_second_en)

ggsave(here::here("plots", "btw21", "second-votes", "btw21_dot_grid_map_second_diff_en_id.pdf"), width = 10, height = 12, device = cairo_pdf)
```


## Zweitstimme — Votes

### Tile Grid Map

```{r titles-votes-zweitstimme}
subtitle_second_votes_de <- "Die stärksten Parteien nach Prozent der Zweitstimmen."
subtitle_second_votes_en <- "The winner parties by percentage of second votes."
```


```{r tile-grid-map-zweitstimme-votes}
g_tile_diff <- g +
  geom_point(
    aes(color = winner_second_de, alpha = winner_second_percent), 
    size = 11, shape = 15
  ) +
  scale_x_continuous(limits = c(-.5, max(grid$col) + 4.5)) +
  scale_alpha(range = c(.25, 1), name = "Zweitstimmen:", labels = scales::percent_format(scale = 1)) +
  guides(color = guide_legend(override.aes = list(size = 8, alpha = .7), order = 1),
         alpha = guide_legend(override.aes = list(size = 8), order = 2)) +
  theme(legend.position = c(.83, .2))

## Deutsche Version
g_tile_diff + labs(title = title_de, subtitle = subtitle_second_votes_de, caption = caption_de)

ggsave(here::here("plots", "btw21", "second-votes", "btw21_tile_grid_map_second_votes_de.pdf"), width = 10, height = 11.3, device = cairo_pdf)

## Englische Version
g_tile_diff + labs(title = title_en, subtitle = subtitle_second_votes_en, caption = caption_en) +
  scale_color_manual(values = party_colors_second, name = NULL, labels = parties_second_en) +
  scale_alpha(range = c(.25, 1), name = "Lead:", labels = scales::percent_format(scale = 1))

ggsave(here::here("plots", "btw21", "second-votes", "btw21_tile_grid_map_second_votes_en.pdf"), width = 10, height = 11.3, device = cairo_pdf)
```

### mit Wahlkreisnummern

```{r tile-grid-map-zweitstimme-votes-wk}
g_tile_diff_id <- g_tile_diff +
  geom_text(
    data = filter(grid_btw, winner_second_percent > 30),
    aes(label = id, color = winner_second_de,
        color = after_scale(lighten(color, .65))),
    size = 3.2, family = "Chivo", fontface = "bold", 
    show.legend = FALSE
  ) +
  geom_text(
    data = filter(grid_btw, winner_second_percent <= 30),
    aes(label = id, color = winner_second_de,
        color = after_scale(darken(color, .35))),
    size = 3.2, family = "Chivo", fontface = "bold", 
    show.legend = FALSE
  )

## Deutsche Version
g_tile_diff_id + 
  labs(title = title_de, subtitle = subtitle_second_votes_de, caption = caption_de)

ggsave(here::here("plots", "btw21", "second-votes", "btw21_tile_grid_map_second_votes_de_id.pdf"), width = 10, height = 11.7, device = cairo_pdf)

## Englische Version
g_tile_diff_id + 
  labs(title = title_en, subtitle = subtitle_second_votes_en, caption = caption_en) +
  scale_fill_manual(values = party_colors_second, name = NULL, labels = parties_second_en) +
  scale_alpha(range = c(.25, 1), name = "Lead:", labels = scales::percent_format(scale = 1))

ggsave(here::here("plots", "btw21", "second-votes", "btw21_tile_grid_map_second_votes_en_id.pdf"), width = 10, height = 11.7, device = cairo_pdf)
```

## Dot Map

```{r dot-grid-map-zweitstimme-votes}
g_dot_diff <- g +
  geom_point(
    aes(color = winner_second_de, alpha = winner_second_percent), 
    size = 8.6, shape = 16
  ) +
  geom_point(
    aes(color = winner_second_de), 
    size = 8.6, shape = 21, stroke = 1.4, fill = "transparent", show.legend = FALSE
  ) +
  scale_alpha(range = c(.25, .85), name = "Zweitstimmen:", labels = scales::percent_format(scale = 1)) +
  guides(color = guide_legend(override.aes = list(size = 6, alpha = .7), order = 1),
         alpha = guide_legend(override.aes = list(size = 6), order = 2)) +
  theme(legend.position = c(.83, .2))

## Deutsche Version
g_dot_diff + 
  labs(title = title_de, subtitle = subtitle_second_votes_de, caption = caption_de)

ggsave(here::here("plots", "btw21", "second-votes", "btw21_dot_grid_map_second_votes_de.pdf"), width = 10, height = 11.7, device = cairo_pdf)

## Englische Version
g_dot_diff + 
  labs(title = title_en, subtitle = subtitle_second_votes_en, caption = caption_en) +
  scale_fill_manual(values = party_colors_second,
                    name = NULL, labels = parties_second_en) +
  scale_alpha(range = c(.25, .85), name = "Zweitstimmen:", labels = scales::percent_format(scale = 1)) 

ggsave(here::here("plots", "btw21", "second-votes", "btw21_dot_grid_map_second_votes_en.pdf"), width = 10, height = 11.7, device = cairo_pdf)
```

### mit Wahlkreisnummern

```{r dot-grid-map-zweitstimme-votes-wk}
g_dot_diff_id <- g_dot_diff +
  geom_text(
    data = filter(grid_btw, winner_second_percent > 30),
    aes(label = id, color = winner_second_de,
        color = after_scale(lighten(color, .65))),
    size = 2.8, family = "Chivo", fontface = "bold", 
    show.legend = FALSE
  ) +
  geom_text(
    data = filter(grid_btw, winner_second_percent <= 30),
    aes(label = id, color = winner_second_de,
        color = after_scale(darken(color, .35))),
    size = 2.8, family = "Chivo", fontface = "bold", 
    show.legend = FALSE
  )

## Deutsche Version
g_dot_diff_id + 
  labs(title = title_de, subtitle = subtitle_second_votes_de, caption = caption_de)

ggsave(here::here("plots", "btw21", "second-votes", "btw21_dot_grid_map_second_votes_de_id.pdf"), width = 10, height = 12, device = cairo_pdf)

## Englische Version
g_dot_diff_id + 
  labs(title = title_en, subtitle = subtitle_second_votes_en, caption = caption_en) +
  scale_fill_manual(values = party_colors_second, name = NULL, labels = parties_second_en)

ggsave(here::here("plots", "btw21", "second-votes", "btw21_dot_grid_map_second_votes_en_id.pdf"), width = 10, height = 12, device = cairo_pdf)
```



## Trends 2021 vs. 2017

### mit Wahlkreisnummern (Quadrate)

```{r tile-grid-map-zweitstimme-trends-wk-1}

# TODO: Chart-Titel

char_arrow_up <-  "\u25B2"
char_arrow_down <-  "\u25BC"
char_level <- "-"

parties <- list(c("CDU", "CSU"), "SPD", "Grüne", "FDP", "AfD", "Linke")

for (party_selected in parties) {
  party_selected_color <- case_when(
    party_selected %in% c("CDU", "CSU") ~ "CDU",
    party_selected == "Grüne" ~ "Bündnis 90/Die Grünen",
    party_selected == "Linke" ~ "Die Linke",
    TRUE ~ party_selected
  )[1]
  
  g <- btw_clean %>% 
    filter(party %in% party_selected) %>% 
    select(electoral_id, name, party, second_percent, second_difference) %>% 
    mutate(second_difference_abs = abs(second_difference)) %>% 
    left_join(grid, by = c("electoral_id" = "id_num")) %>%  
    ggplot(aes(col, row)) +
    coord_fixed() +
    scale_x_continuous(limits = c(-.5, max(grid$col) + 4)) +
    scale_y_reverse(expand = c(.03, .03)) +
    scale_color_manual(values = party_colors_first, name = NULL) +
    scale_fill_manual(values = party_colors_first, name = NULL) +
    guides(color = guide_legend(override.aes = list(size = 6)),
           fill = guide_legend(override.aes = list(size = 6))) +
    theme(legend.position = c(.82, .27))
  
  g_tile_diff <- g +
    geom_point(
      aes(alpha = second_difference_abs), 
      color = party_colors[party_selected_color],
      size = 11, shape = 15
    ) +
    scale_x_continuous(limits = c(-.5, max(grid$col) + 4.5)) +
    scale_alpha(range = c(.25, 1), name = "Absolute Veränderung:", labels = scales::percent_format(scale = 1)) +
    guides(color = guide_legend(override.aes = list(size = 8, alpha = .7), order = 1),
           alpha = guide_legend(override.aes = list(size = 8), order = 2)) +
    theme(legend.position = c(.83, .2))
  
  g_tile_diff_sign <- g_tile_diff +
    geom_text(
      aes(label = case_when(
        second_difference > 0 ~ char_arrow_up,
        second_difference < 0 ~ char_arrow_down,
        is.na(second_difference) ~ "", # für die Grünen im Saarland
        TRUE ~ char_level),
          alpha = second_difference_abs),
      color = "white",
      size = 3.2, family = "Chivo", fontface = "bold", 
      show.legend = FALSE
    )
  
  ## Deutsche Version
  g_tile_diff_sign +
    labs(title = title_de, subtitle = subtitle_second_votes_de, caption = caption_de)
  
  ggsave(here::here("plots", "btw21", "second-votes", glue("btw21_tile_grid_map_second_trend_{party_selected[1]}_de.pdf")), 
         width = 10, height = 11.7, device = cairo_pdf)
  
  ## Englische Version
  g_tile_diff_sign + 
    labs(title = title_en, subtitle = subtitle_second_votes_en, caption = caption_en) +
    scale_fill_manual(values = party_colors_first, name = NULL, labels = parties_second_en) +
    scale_alpha(range = c(.25, 1), name = "Absolute Change:", labels = scales::percent_format(scale = 1))
  
   ggsave(here::here("plots", "btw21", "second-votes", glue("btw21_tile_grid_map_second_trend_{party_selected[1]}_en.pdf")), 
         width = 10, height = 11.7, device = cairo_pdf)
  
}  
  
```


### mit Wahlkreisnummern (Quadrate, Symbole gefärbt)

```{r tile-grid-map-zweitstimme-trends-wk-2}

# TODO: Chart-Titel

char_arrow_up <-  "\u25B2"
char_arrow_down <-  "\u25BC"
char_level <- "-"

parties <- list(c("CDU", "CSU"), "SPD", "Grüne", "FDP", "AfD", "Linke")


for (party_selected in parties) {
  party_selected_color <- case_when(
    party_selected %in% c("CDU", "CSU") ~ "CDU",
    party_selected == "Grüne" ~ "Bündnis 90/Die Grünen",
    party_selected == "Linke" ~ "Die Linke",
    TRUE ~ party_selected
  )[1]
  
  g <- btw_clean %>% 
    filter(party %in% party_selected) %>% 
    select(electoral_id, name, party, second_percent, second_difference) %>% 
    mutate(second_difference_abs = abs(second_difference)) %>% 
    left_join(grid, by = c("electoral_id" = "id_num")) %>%  
    ggplot(aes(col, row)) +
    coord_fixed() +
    scale_x_continuous(limits = c(-.5, max(grid$col) + 4)) +
    scale_y_reverse(expand = c(.03, .03)) +
    # scale_color_manual(values = party_colors_first, name = NULL) +
    scale_fill_manual(values = party_colors_first, name = NULL) +
    guides(color = guide_legend(override.aes = list(size = 6)),
           fill = guide_legend(override.aes = list(size = 6))) +
    theme(legend.position = c(.82, .27))
  
  g_tile_diff <- g +
    geom_point(
      aes(alpha = second_difference_abs), 
      color = party_colors[party_selected_color],
      size = 11, shape = 15
    ) +
    scale_x_continuous(limits = c(-.5, max(grid$col) + 4.5)) +
    scale_alpha(range = c(.25, 1), name = "Absolute Veränderung:", labels = scales::percent_format(scale = 1)) +
    guides(color = guide_legend(override.aes = list(size = 8, alpha = .7), order = 1),
           alpha = guide_legend(override.aes = list(size = 8), order = 2)) +
    theme(legend.position = c(.83, .2))
  
  g_tile_diff_sign <- g_tile_diff +
    geom_text(
      aes(label = case_when(
        second_difference > 0 ~ char_arrow_up,
        second_difference < 0 ~ char_arrow_down,
        is.na(second_difference) ~ "", # für die Grünen im Saarland
        TRUE ~ char_level),
        color = case_when(
        second_difference > 0 ~ "white",
        second_difference < 0 ~ "grey8"),
          alpha = second_difference_abs),
      size = 3.2, family = "Chivo", fontface = "bold", 
      show.legend = FALSE
    ) +
    scale_color_identity()
  
  ## Deutsche Version
  g_tile_diff_sign +
    labs(title = title_de, subtitle = subtitle_second_votes_de, caption = caption_de)
  
  ggsave(here::here("plots", "btw21", "second-votes", glue("btw21_tile_grid_map_second_trend_{party_selected[1]}_de.pdf")), 
         width = 10, height = 11.7, device = cairo_pdf)
  
  ## Englische Version
  g_tile_diff_sign + 
    labs(title = title_en, subtitle = subtitle_second_votes_en, caption = caption_en) +
    scale_fill_manual(values = party_colors_first, name = NULL, labels = parties_second_en) +
    scale_alpha(range = c(.25, 1), name = "Absolute Change:", labels = scales::percent_format(scale = 1))
  
   ggsave(here::here("plots", "btw21", "second-votes", glue("btw21_tile_grid_map_second_trend_{party_selected[1]}_en.pdf")), 
         width = 10, height = 11.7, device = cairo_pdf)
  
}  
  
  
```


```{r convert, eval=FALSE}
pdfs <- list.files(here::here('plots', 'btw21'), pattern = "*.pdf", recursive = TRUE)
for(pdf in pdfs) {
  pdf_convert(pdf = glue::glue("{here::here('plots', 'btw21')}/{pdf}"), 
              filenames = glue::glue("{here::here('plots', 'btw21')}/{str_remove(pdf, '.pdf')}.png"),
              format = "png", dpi = 500)
}
```



***

<details><summary>Session Info</summary>

```{r sessionInfo}
Sys.time()
sessionInfo()
```

</details>
