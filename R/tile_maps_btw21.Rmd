---
title: "Ergebnisse Bundestagswahl 2021" 
description: ""
author:
    - name: "Cédric Scherer"
      url: https://cedricscherer.com
    - name: "Ansgar Wolsing"
      url: 
date: "`r Sys.Date()`"
output: 
    distill::distill_article:
        highlight: kate
        code_folding: false  
        toc: true            
        toc_depth: 2         
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,
                      fig.width = 10, fig.height = 12, 
                      dev = "ragg_png", res = 1000, retina = 1)
```

# Setup

```{r prep}
pacman::p_load("tidyverse", "here", "glue", "colorspace", "pdftools")
```


# Daten

## Tile Grid Map

```{r grid-constituencies}
grid <- read_csv(here("data", "de_constituencies_grid.csv")) %>% 
  mutate(id_num = as.numeric(id))
```


## Ergebnisse Bundestagswahl 2021

Source: 

```{r data-btw21}
btw_raw <- read_csv(here("data", "btw21_DieZeit.csv"))

btw_clean <- btw_raw %>% 
  mutate(
    winner_de = case_when(
      party == "CDU" ~ "CDU",
      party == "SPD" ~ "SPD",
      party == "Grüne" ~ "Bündnis 90/Die Grünen",
      party == "FDP" ~ "FDP",
      party == "AfD" ~ "AfD",
      party == "Linke" ~ "Die Linke",
      party == "CSU" ~ "CSU",
      TRUE ~ "Andere"
    ),
    winner_en = case_when(
      party == "Grüne" ~ "Alliance 90/The Greens",
      party == "Linke" ~ "The Left",
      winner_de == "Andere" ~ "Other",
      TRUE ~ winner_de
    ),
    winner_de = factor(winner_de, levels = c("SPD", "CDU", "CSU", "Bündnis 90/Die Grünen", 
                                              "FDP", "AfD", "Die Linke", "Andere")),
    winner_en = factor(winner_en, levels = c("SPD", "CDU", "CSU", "Alliance 90/The Greens", 
                                              "FDP", "AfD", "The Left", "Other"))
  )
```

```{r data-btw21-first-vote}
btw_first <- 
  btw_clean %>% 
  group_by(electoral_id) %>%
  arrange(-first_percent) %>% 
  slice(1:2) %>% 
  mutate(rank = row_number()) %>% 
  dplyr::select(electoral_id, first_percent, winner_de, winner_en, rank) %>% 
  pivot_wider(
    id_cols = c(electoral_id),
    names_from = rank,
    values_from = c(first_percent, winner_de, winner_en)
  ) %>% 
  mutate(
    winner_first_de = winner_de_1,
    winner_first_en = winner_en_1,
    follow_first_de = winner_de_2,
    follow_first_en = winner_en_2,
    winner_first_percent = first_percent_1,
    follow_first_percent = first_percent_2,
    difference_first_percent = first_percent_1 - first_percent_2
  ) %>% 
  dplyr::select(-ends_with("_1"), -ends_with("_2"))
```

```{r data-btw21-second-vote}
btw_second <- 
  btw_clean %>% 
  group_by(electoral_id) %>%
  arrange(-second_percent) %>% 
  slice(1:2) %>% 
  mutate(rank = row_number()) %>% 
  dplyr::select(electoral_id, second_percent, winner_de, winner_en, rank) %>% 
  pivot_wider(
    id_cols = c(electoral_id),
    names_from = rank,
    values_from = c(second_percent, winner_de, winner_en)
  ) %>% 
  mutate(
    winner_second_de = winner_de_1,
    winner_second_en = winner_en_1,
    follow_second_de = winner_de_2,
    follow_second_en = winner_en_2,
    winner_second_percent = second_percent_1,
    follow_second_percent = second_percent_2,
    difference_second_percent = second_percent_1 - second_percent_2
  ) %>% 
  dplyr::select(-ends_with("_1"), -ends_with("_2"))
```

## Kombinierte Datensätze

```{r data-join}
grid_btw <- 
  grid %>% 
  left_join(btw_first, by = c("id_num" = "electoral_id")) %>% 
  left_join(btw_second, by = c("id_num" = "electoral_id"))
```


# Visualisierungen

## Setup

```{r}
theme_set(theme_void(base_family = "Editorial New")) #Editorial New, Noto Serif
theme_update(legend.margin = margin(0, 10, 0, 25),
             legend.text = element_text(size = 16, margin = margin(5, 0, 5, -2.5),
                                        family = "Chivo"),
             plot.title = element_text(hjust = .5, face = "bold", size = 30,
                                       lineheight = 1.1, margin = margin(t = 10, b = 20)),
             plot.subtitle = element_text(hjust = .5, color = "grey33", size = 22,
                                          margin = margin(t = -15, b = 18)),
             plot.title.position = "plot",
             plot.caption = element_text(hjust = 0, color = "grey33", 
                                         lineheight = 1.3,
                                         size = 12, margin = margin(20, 0, 5, 5)),
             plot.caption.position = "plot",
             plot.margin = margin(10, 0, 10, 0))

# Party colors
party_colors <- c("CDU" = "#212121",
                  "CSU" = "grey33",
                  "SPD" = "#ca0002", ## "#E3000F",  a bit darker now to make it work with CVD
                  "Bündnis 90/Die Grünen" = rgb(100, 161, 45, maxColorValue = 255),
                  "FDP" = darken("#ffed00", 0.1),
                  "Die Linke" = "purple",
                  "AfD" = rgb(0, 158, 224, maxColorValue = 255),
                  "Andere" = "grey74")

party_colors_first <- party_colors[c(1, 2, 3, 4, 6, 7)]
party_colors_second <- party_colors[c(1, 2, 3, 4, 7)]

caption_de <- "Grafik: Cédric Scherer & Ansgar Wolsing • Daten: DIE ZEIT"
caption_en <- "Graphic: Cédric Scherer & Ansgar Wolsing • Source: DIE ZEIT"
```


## Erststimme — Gewinner

### Tile Grid Map

```{r titles-first}
title_first_de <- "Ergebnisse der Bundestagswahl 2021"
subtitle_first_de <- "Die stärksten Parteien nach Erststimmen."

title_first_en <- "Results of the German National Election 2021"
subtitle_first_en <- "The winner parties by first votes."

parties_en <- unique(grid_btw$winner_first_en)
```


```{r tile-grid-map-erststimme}
g_tile <- ggplot(grid_btw, aes(col, row)) +
  geom_point(
    aes(color = winner_first_de), 
    size = 11, shape = 15
  ) +
  coord_fixed() +
  scale_x_continuous(limits = c(-.5, max(grid$col) + 4)) +
  scale_y_reverse(expand = c(.03, .03)) +
  scale_color_manual(values = party_colors_first, name = NULL) +
  guides(color = guide_legend(override.aes = list(size = 8))) +
  theme(legend.position = c(.82, .27))

## Deutsche Version
g_tile + labs(title = title_first_de, subtitle = subtitle_first_de, caption = caption_de)
ggsave(here::here("plots", "btw21", "btw21_tile_grid_map_first_de.pdf"), width = 10, height = 12, device = cairo_pdf)

## Englische Version
g_tile + labs(title = title_first_en, subtitle = subtitle_first_en, caption = caption_en) +
  scale_fill_manual(values = party_colors_first, name = NULL, labels = parties_en)
ggsave(here::here("plots", "btw21", "btw21_tile_grid_map_first_en.pdf"), width = 10, height = 12, device = cairo_pdf)
```

### mit Wahlkreisnummern

```{r tile-grid-map-erststimme-wk}
g_tile_id <- g_tile +
  geom_text(
    aes(label = id, color = winner_first_de, 
        color = after_scale(lighten(color, .35))),
    size = 3.2, family = "Chivo", fontface = "bold",
    show.legend = FALSE
  )
  # geom_text(
  #   aes(label = id),
  #   size = 3.2, family = "Chivo", 
  #   color = "#fefefe", fontface = "bold"
  # )

## Deutsche Version
g_tile_id + labs(title = title_first_de, subtitle = subtitle_first_de, caption = caption_de)
ggsave(here::here("plots", "btw21", "btw21_tile_grid_map_first_id_de.pdf"), width = 10, height = 12, device = cairo_pdf)

## Englische Version
g_tile_id + labs(title = title_first_en, subtitle = subtitle_first_en, caption = caption_en) +
  scale_fill_manual(values = party_colors_first, name = NULL, labels = parties_en)
ggsave(here::here("plots", "btw21", "btw21_tile_grid_map_first_id_en.pdf"), width = 10, height = 12, device = cairo_pdf)
```

## Dot Map

```{r dot-grid-map-erststimme}
g_dot <- ggplot(grid_btw, aes(col, row)) +
  geom_point(aes(color = winner_first_de), size = 10) +
  coord_fixed() +
  scale_x_continuous(limits = c(-.5, max(grid$col) + 4)) +
  scale_y_reverse(expand = c(.03, .03)) +
  scale_color_manual(values = party_colors_first, name = NULL) +
  guides(color = guide_legend(override.aes = list(size = 6))) +
  theme(legend.position = c(.82, .27))

## Deutsche Version
g_dot + labs(title = title_first_de, subtitle = subtitle_first_de, caption = caption_de)
ggsave(here::here("plots", "btw21", "btw21_dot_grid_map_first_de.pdf"), width = 10, height = 12, device = cairo_pdf)

## Englische Version
g_dot + labs(title = title_first_en, subtitle = subtitle_first_en, caption = caption_en) +
  scale_color_manual(values = party_colors_first,
                     name = NULL, labels = parties_en)
ggsave(here::here("plots", "btw21", "btw21_dot_grid_map_first_en.pdf"), width = 10, height = 12, device = cairo_pdf)
```

### mit Wahlkreisnummern

```{r dot-grid-map-erststimme-wk}
g_dot_id <- g_dot +
  geom_text(
    aes(label = id, color = winner_first_de, 
        color = after_scale(lighten(color, .35))),
    size = 3.1, family = "Chivo", fontface = "bold",
    show.legend = FALSE
  )
  # geom_text(
  #   aes(label = id),
  #   size = 3.1, family = "Chivo", 
  #   color = "#fefefe", fontface = "bold"
  # )

## Deutsche Version
g_dot_id + labs(title = title_first_de, subtitle = subtitle_first_de, caption = caption_de)
ggsave(here::here("plots", "btw21", "btw21_dot_grid_map_first_id_de.pdf"), width = 10, height = 12, device = cairo_pdf)

## Englische Version
g_dot_id + labs(title = title_first_en, subtitle = subtitle_first_en, caption = caption_en) +
  scale_fill_manual(values = party_colors_first, name = NULL, labels = parties_en)
ggsave(here::here("plots", "btw21", "btw21_dot_grid_map_first_id_en.pdf"), width = 10, height = 12, device = cairo_pdf)
```


### Variante mit gedämpfteren Farben für die Füllung der Punkte

```{r dot-grid-map-erststimme-light}
g_dot_light <- 
  ggplot(grid_btw, aes(col, row)) +
  geom_point(
    aes(fill = winner_first_de), 
    size = 10, shape = 21, stroke = 2, alpha = .5, color = "transparent"
  ) +
  geom_point(
    aes(color = winner_first_de), 
    size = 10, shape = 21, stroke = 2, fill = "transparent"
  ) +
  coord_fixed() +
  scale_x_continuous(limits = c(-.5, max(grid$col) + 4)) +
  scale_y_reverse(expand = c(.03, .03)) +
  scale_color_manual(values = party_colors_first, name = NULL) +
  scale_fill_manual(values = party_colors_first, name = NULL) +
  guides(color = guide_legend(override.aes = list(size = 6))) +
  theme(legend.position = c(.81, .27),
        legend.text = element_text(margin = margin(5, 0, 5, 0)))

## Deutsche Version
g_dot_light + labs(title = title_first_de, subtitle = subtitle_first_de, caption = caption_de)

ggsave(here::here("plots", "btw21", "btw21_dot_grid_map_de_light.pdf"), width = 10, height = 13, device = cairo_pdf)
 
## Englische Version
g_dot_light + labs(title = title_first_en, subtitle = subtitle_first_en, caption = caption_en) +
  scale_color_manual(values =party_colors_first,
                     name = NULL, labels = parties_en) +
  scale_fill_manual(values = party_colors_first,
                    name = NULL, labels = parties_en)

ggsave(here::here("plots", "btw21", "btw21_dot_grid_map_en_light.pdf"), width = 10, height = 13, device = cairo_pdf)
```


## Erststimme —  Vorsprung

###  


##### OLD

## Grid Map inkl. Vorsprung als Farbintensität

### Vorsprung in Prozentpunkten

```{r variant-grid-vorsprung}
g <- 
  ggplot(dat_winneronly_grid, aes(col, row)) +
  geom_point(
    aes(fill = outcome_agg, alpha = diff), 
    size = 11.5, shape = 22, stroke = 1.5, color = "transparent"
  ) +
  geom_point(
    aes(color = outcome_agg), 
    size = 11.5, shape = 22, stroke = 1.5, fill = "transparent"
  ) +
  coord_fixed() +
  scale_x_continuous(limits = c(-.5, max(grid$col) + 2)) +
  scale_y_reverse(expand = c(.03, .03)) +
  scale_color_manual(values = c(party_colors, c("Kopf-an-Kopf" = "grey85")), name = NULL) +
  scale_fill_manual(values = c(party_colors, c("Kopf-an-Kopf" = "transparent")), name = NULL) +
  scale_alpha(range = c(0, .86), guide = "none") +
  guides(fill = guide_legend(override.aes = list(size = 6, alpha = .9))) +
  theme(legend.position = c(.82, .27))

## Deutsche Version
g + labs(title = title_de, caption = caption_de,
         subtitle = "Je intensiver die Färbung, desto größer ist der vorhergesagte Vorsprung.")

ggsave(here::here("plots", "grid_map_diff_de.pdf"), width = 10, height = 13, device = cairo_pdf)

## Englische Version
g + labs(title = title_en, caption = caption_en,
         subtitle = "The more intense the coloring of the dots, the greater the predicted lead.") +
  scale_color_manual(values = c(party_colors, c("Kopf-an-Kopf" = "grey85")),
                     name = NULL, labels = parties_en) +
  scale_fill_manual(values = c(party_colors, c("Kopf-an-Kopf" = "grey85")),
                    name = NULL, labels = parties_en)

ggsave(here::here("plots", "grid_map_diff_en.pdf"), width = 10, height = 13, device = cairo_pdf)
```

## Bubble Map inkl. Vorsprung als Farbintensität

### Vorsprung in Prozentpunkten

```{r variant-bubble-vorsprung}
g <- 
  ggplot(dat_winneronly_grid, aes(col, row)) +
  geom_point(
    aes(fill = outcome_agg, alpha = diff), 
    size = 9, shape = 21, stroke = 2, color = "transparent"
  ) +
  geom_point(
    aes(color = outcome_agg), 
    size = 9, shape = 21, stroke = 2, fill = "transparent"
  ) +
  coord_fixed() +
  scale_x_continuous(limits = c(-.5, max(grid$col) + 2)) +
  scale_y_reverse(expand = c(.03, .03)) +
  scale_color_manual(values = c(party_colors, c("Kopf-an-Kopf" = "grey85")), name = NULL) +
  scale_fill_manual(values = c(party_colors, c("Kopf-an-Kopf" = "transparent")), name = NULL) +
  scale_alpha(range = c(0, .86), guide = "none") +
  guides(fill = guide_legend(override.aes = list(size = 6, alpha = .9))) +
  theme(legend.position = c(.82, .27))

## Deutsche Version
g + labs(title = title_de, caption = caption_de,
         subtitle = "Je intensiver die Färbung, desto größer ist der vorhergesagte Vorsprung.")

ggsave(here::here("plots", "bubble_map_diff_de.pdf"), width = 10, height = 13, device = cairo_pdf)

## Englische Version
g + labs(title = title_en, caption = caption_en,
         subtitle = "The more intense the coloring of the dots, the greater the predicted lead.") +
  scale_color_manual(values = c(party_colors, c("Kopf-an-Kopf" = "grey85")),
                     name = NULL, labels = parties_en) +
  scale_fill_manual(values = c(party_colors, c("Kopf-an-Kopf" = "grey85")),
                    name = NULL, labels = parties_en)

ggsave(here::here("plots", "bubble_map_diff_en.pdf"), width = 10, height = 13, device = cairo_pdf)
```


### Vorsprung als t-Statistik

```{r variant-vorsprung-ttest}
g <- 
  ggplot(dat_winneronly_grid, aes(col, row)) +
  geom_point(
    aes(fill = outcome_agg, 
        # alpha = diff
        alpha = t # Ergebnis t-Test (oder p-value stattdessen?)
        ), 
    size = 9, shape = 21, stroke = 2, color = "transparent"
  ) +
  geom_point(
    aes(color = outcome_agg), 
    size = 9, shape = 21, stroke = 2, fill = "transparent"
  ) +
  coord_fixed() +
  scale_x_continuous(limits = c(-.5, max(grid$col) + 2)) +
  scale_y_reverse(expand = c(.03, .03)) +
  scale_color_manual(values = c(party_colors, c("Kopf-an-Kopf" = "grey85")), name = NULL) +
  scale_fill_manual(values = c(party_colors, c("Kopf-an-Kopf" = "transparent")), name = NULL) +
  scale_alpha(range = c(0, .86), guide = "none") +
  guides(fill = guide_legend(override.aes = list(size = 6, alpha = .9))) +
  theme(legend.position = c(.82, .27))

## Deutsche Version
g + labs(title = title_de, caption = glue("{caption_de}\nDie Vorhersage der Mandatsgewinner basiert auf einem t-Test auf Basis von Mittelwert und Standardabweichung."),
         subtitle = "Je intensiver die Färbung, desto größer ist der vorhergesagte Vorsprung.")

ggsave(here::here("plots", "bubble_map_t_test_de.pdf"), width = 10, height = 13, device = cairo_pdf)

## Englische Version
g + labs(title = title_en, caption = glue("{caption_en}\nThe prediction of mandate winners is based on a t-test based on mean and standard deviation."),
         subtitle = "The more intense the coloring, the greater the predicted lead.") +
  scale_color_manual(values = c(party_colors, c("Kopf-an-Kopf" = "grey85")),
                     name = NULL, labels = parties_en) +
  scale_fill_manual(values = c(party_colors, c("Kopf-an-Kopf" = "grey85")),
                    name = NULL, labels = parties_en)

ggsave(here::here("plots", "bubble_map_t_test_en.pdf"), width = 10, height = 13, device = cairo_pdf)
```



## Bubble Map inkl. Grenzen der Bundesländer (trial)

*Leider nicht so schön und sinnvoll wie erhofft.*

```{r variant-states-ggforce, eval=FALSE}
ggplot(dat_winneronly_grid, aes(col, row)) +
  ggforce::geom_mark_hull(
    aes(group = bundesland_de), 
    color = "white",
    expand = unit(0, "mm")
  ) +
  geom_point(aes(color = outcome_agg), size = 7) +
  coord_fixed() +
  scale_x_continuous(limits = c(-.5, max(grid$col) + 2)) +
  scale_y_reverse(expand = c(.03, .03)) +
  scale_color_manual(values = c(party_colors, c("Kopf-an-Kopf" = "grey85")),
                     name = NULL) +
  guides(color = guide_legend(override.aes = list(size = 6))) +
  theme(legend.position = c(.82, .27),
        plot.background = element_rect(color = "grey67", fill = "grey67")) +
  labs(title = title_de, caption = caption_de)

ggsave(here::here("plots", "bubble_map_states.pdf"), width = 10, height = 13, device = cairo_pdf)
```



## Bubble Map mit verschiedenen Punktgrößen für Bundesländer (trial)

*Weder effektiv noch schön.*

```{r variant-vorsprung-mark-size, eval=FALSE}
# Größenkategorien für Bundesländer
bland_group_mapping <- c(
  "Schleswig-Holstein" = "A",
  "Mecklenburg-Vorpommern" = "B",
  "Hamburg" = "D",
  "Niedersachsen" = "C",
  "Bremen" = "E",
  "Brandenburg" = "A",
  "Sachsen-Anhalt" = "D",
  "Berlin" = "A",
  "Nordrhein-Westfalen" = "D",
  "Sachsen" = "A",
  "Hessen" = "E",
  "Thüringen" = "B",
  "Rheinland-Pfalz" = "A",
  "Bayern" = "D",
  "Baden-Württemberg" = "B",
  "Saarland" = "A"
)

dat_winneronly_grid %>% 
  mutate(mark_group = bland_group_mapping[bundesland_de],
         mark_shape = case_when(
           mark_group == "A" ~ 21,
           mark_group == "B" ~ 22,
           mark_group == "C" ~ 23,
           mark_group == "D" ~ 24,
           mark_group == "E" ~ 25,
         )) %>% 
  ggplot(aes(col, row)) +
  geom_point(
    aes(fill = outcome_agg, alpha = diff, size = mark_group), 
    # size = 9, 
    shape = 21, 
    stroke = 2, color = "transparent"
  ) +
  geom_point(
    aes(color = outcome_agg, size = mark_group), 
    # size = 9, 
    shape = 21, 
    stroke = 2, fill = "transparent"
  ) +
  coord_fixed() +
  scale_x_continuous(limits = c(-.5, max(grid$col) + 2)) +
  scale_y_reverse(expand = c(.03, .03)) +
  scale_color_manual(values = c(party_colors, c("Kopf-an-Kopf" = "grey85")), name = NULL) +
  scale_fill_manual(values = c(party_colors, c("Kopf-an-Kopf" = "transparent")), name = NULL) +
  scale_alpha(range = c(0, .86), guide = "none") +
  scale_size_discrete(range = c(7, 11)) +
  # scale_shape_identity() +
  guides(fill = guide_legend(override.aes = list(size = 6, alpha = .9)),
         size = "none") +
  theme(legend.position = c(.82, .27)) +
  labs(title = title_de, caption = caption_de,
       subtitle = "Je intensiver die Färbung, desto größer ist der vorhergesagte Vorsprung.")

ggsave(here::here("plots", "bubble_map_diff_bland_mark.pdf"), width = 10, height = 13, device = cairo_pdf)
```



## Bubble Map inkl. Vorsprung als Farbintensität - mit Städten zur Orientierung

```{r map-lead-label}
constituencies_to_highlight <- c(
  18, # Hamburg-Mitte
  75, # Berlin-Mitte
  93, # Köln I
  220 # München-West/Mitte
)

df_constituencies_highlight <- dat_winneronly_grid %>% 
  filter(wkr %in% constituencies_to_highlight) %>% 
  mutate(name_short = str_extract(Wahlkreisname, "[a-zA-ZäöüÄÖÜ]+")) %>% 
  select(name_short, name, col, row)
```


### Städtenamen als Overlay

```{r variant-vorsprung-location-hints-1, eval=FALSE}
ggplot(dat_winneronly_grid, aes(col, row)) +
  geom_point(
    aes(fill = outcome_agg, alpha = diff), 
    size = 9, shape = 21, stroke = 2, color = "transparent"
  ) +
  geom_point(
    aes(color = outcome_agg), 
    size = 9, shape = 21, stroke = 2, fill = "transparent"
  ) +
  geom_label(data = df_constituencies_highlight,
             aes(label = name_short),
             col = "grey99",
             fill = "grey10", alpha = 0.4, family = "Roboto",
             label.size = 0, 
             fontface = "bold", size = 6,
             hjust = 0.5) +
  coord_fixed() +
  scale_x_continuous(limits = c(-.5, max(grid$col) + 2)) +
  scale_y_reverse(expand = c(.03, .03)) +
  scale_color_manual(values = c(party_colors, c("Kopf-an-Kopf" = "grey85")), name = NULL) +
  scale_fill_manual(values = c(party_colors, c("Kopf-an-Kopf" = "transparent")), name = NULL) +
  scale_alpha(range = c(0, .86), guide = "none") +
  guides(fill = guide_legend(override.aes = list(size = 6, alpha = .9))) +
  theme(legend.position = c(.82, .27)) +
  labs(title = title_de, caption = caption_de,
       subtitle = "Je intensiver die Färbung, desto größer ist der vorhergesagte Vorsprung.")

ggsave(here::here("plots", "bubble_map_diff_location_highlights.pdf"), width = 10, height = 13, device = cairo_pdf)
```

### Städtenamen als Labels

```{r variant-vorsprung-location-hints-2, eval=FALSE}
labels <- dat_winneronly_grid %>% 
  filter(str_detect(wk, "München|Köln") | bundesland_de %in% c("Berlin", "Hamburg")) %>% 
  filter(wk != "München-Land") %>% 
  mutate(label = case_when(
    str_detect(wk, "München") ~ "München",
    str_detect(wk, "Köln") ~ "Köln",
    TRUE ~ bundesland_de
  ))


ggplot(dat_winneronly_grid, aes(col, row)) +
  geom_tile(
    data = labels,
    fill = "grey60", color = "grey60"
  ) +
  geom_point(
    fill = "white", size = 9, shape = 21, stroke = 2, color = "transparent"
  ) +
  geom_point(
    aes(fill = outcome_agg, alpha = diff), 
    size = 9, shape = 21, stroke = 2, color = "transparent"
  ) +
  geom_point(
    aes(color = outcome_agg), 
    size = 9, shape = 21, stroke = 2, fill = "transparent"
  ) +
  # ggforce::geom_mark_hull(
  #   data = labels,
  #   aes(group = label),
  #   concavity = 0
  # ) +
  coord_fixed() +
  scale_x_continuous(limits = c(-.5, max(grid$col) + 2)) +
  scale_y_reverse(expand = c(.03, .03)) +
  scale_color_manual(values = c(party_colors, c("Kopf-an-Kopf" = "grey85")), name = NULL) +
  scale_fill_manual(values = c(party_colors, c("Kopf-an-Kopf" = "transparent")), name = NULL) +
  scale_alpha(range = c(0, .86), guide = "none") +
  guides(fill = guide_legend(override.aes = list(size = 6, alpha = .9))) +
  theme(legend.position = c(.82, .27)) +
  labs(title = title_de, caption = caption_de,
       subtitle = "Je intensiver die Färbung, desto größer ist der vorhergesagte Vorsprung.")

ggsave(here::here("plots", "bubble_map_diff_location_highlights_ggforce.pdf"), width = 10, height = 13, device = cairo_pdf)
```



## Interaktive Version via {ggiraph}

```{r, interactive-version}
library(ggiraph)

g_interactive <- dat_winneronly_grid %>% 
  mutate(label = str_wrap(glue::glue("{Wahlkreisname} ({bundesland_de})<br><br>Vorsprung:<br>{outcome} {diff}%"), 50)) %>% 
  ggplot(aes(col, row)) +
  geom_point_interactive(
    aes(fill = outcome_agg, alpha = diff, tooltip = label, data_id = label), 
    size = 9, shape = 21, stroke = 2, color = "transparent"
  ) +
  geom_point(
    aes(color = outcome_agg), 
    size = 9, shape = 21, stroke = 2, fill = "transparent"
  ) +
  coord_fixed() +
  scale_x_continuous(limits = c(-.5, max(grid$col) + 2)) +
  scale_y_reverse(expand = c(.03, .03)) +
  scale_color_manual(values = c(party_colors, c("Kopf-an-Kopf" = "grey85")), name = NULL) +
  scale_fill_manual(values = c(party_colors, c("Kopf-an-Kopf" = "transparent")), name = NULL) +
  scale_alpha(range = c(0, .86), guide = "none") +
  guides(color = guide_legend(override.aes = list(size = 6))) +
  labs(title = title_de, caption = caption_de)

tooltip_css <- "background-color:#515151;color:white;font-family:Roboto;padding:10px;border-radius:5px;"

girafe(ggobj = g_interactive, 
       width_svg = 12, height_svg = 12, 
       options = list(
         opts_sizing(rescale = FALSE),
         opts_tooltip(offx = 50, css = tooltip_css)
       ))
#ggsave(here::here("plots", "bubble_map_states.pdf"), width = 10, height = 13, device = cairo_pdf)
```


## Hexagon Tiles

```{r hexagon-tiles}
## READ GEOMETRY ==============================================
#' https://pitchinteractiveinc.github.io/tilegrams/
#' Download geometry "Germany - Constituencies" as TopoJSON
#' and place it in the data directory
filepath_topo <- here("data", "tiles.topo.json")
wk_topo <- geojsonio::topojson_read(filepath_topo)
wk_topo <- wk_topo %>% mutate(id = as.numeric(id))

# Merge shapes of constituencies into state-level shapes 
bland_shape <- wk_topo %>% 
  inner_join(dat_winneronly_grid, by = c("id" = "wkr")) %>% 
  group_by(bundesland_de) %>% 
  summarize(geometry = st_union(geometry))

df_constituencies_highlight_hex <- wk_topo %>% 
  filter(id %in% constituencies_to_highlight) %>% 
  mutate(geometry = st_make_valid(geometry) %>% 
           st_centroid(),
         lon = map(geometry, 1),
         lat = map(geometry, 2),
         name_short = str_extract(name, "[a-zA-ZäöüÄÖÜ]+"))
```




```{r hexagon}
g <- dat_winneronly_grid %>% 
  inner_join(wk_topo, by = c("wkr" = "id")) %>% 
  ggplot(aes(geometry = geometry)) +
  geom_sf(aes(fill = outcome_agg, col = outcome_agg, alpha = diff),
          size = 0.1, # col = "grey80"
          ) +
  geom_sf_text(aes(label = id),
               size = 2.5, family = "Roboto Mono") +
  geom_sf(data = bland_shape,
          aes(geometry = geometry, 
              group = bundesland_de),
          fill = NA, col = "grey96",
          size = 2, show.legend = FALSE) +
  geom_sf(aes(col = outcome_agg),
          size = 0.1, fill = "transparent"
          ) +
  # geom_sf_label(data = df_constituencies_highlight_hex,
  #            aes(lon, lat, label = name_short),
  #            col = "grey99",
  #            fill = "grey10", alpha = 0.4, family = "Roboto",
  #            label.size = 0,
  #            fontface = "bold", size = 6,
  #            hjust = 0.5) +
  #scale_x_continuous(limits = c(NA, )) +
  scale_y_continuous(expand = c(.01, .01)) +
  scale_color_manual(values = c(party_colors, c("Kopf-an-Kopf" = "grey85")), name = NULL) +
  scale_fill_manual(values = c(party_colors, c("Kopf-an-Kopf" = "transparent")), name = NULL) +
  scale_alpha(range = c(0, .86), guide = "none") +
  guides(fill = guide_legend(override.aes = list(size = 0.25, alpha = .5))) +
  theme(legend.position = c(.08, .15),
        legend.key.size = unit(5, "mm"))

## Deutsche Version
g + labs(title = title_de, 
         subtitle = "Je intensiver die Färbung, desto größer ist der vorhergesagte Vorsprung.",
         caption = glue("{caption_de}\nTilegram-Geometrie: pitchinteractiveinc.github.io"))

ggsave(here::here("plots", "hexagon_map_diff_de.pdf"), width = 10, height = 13, device = cairo_pdf)

## Englische Version
g + labs(title = title_en, 
         subtitle = "The more intense the coloring of the dots, the greater the predicted lead.",
         caption = glue("{caption_en}\nTilegram-Geometrie: pitchinteractiveinc.github.io")) +
  scale_color_manual(values = c(party_colors, c("Kopf-an-Kopf" = "grey85")),
                     name = NULL, labels = parties_en) +
  scale_fill_manual(values = c(party_colors, c("Kopf-an-Kopf" = "grey85")),
                    name = NULL, labels = parties_en)

ggsave(here::here("plots", "hexagon_map_diff_en.pdf"), width = 10, height = 13, device = cairo_pdf)
``` 

```{r hexagon-ttest}
g <- dat_winneronly_grid %>% 
  inner_join(wk_topo, by = c("wkr" = "id")) %>% 
  ggplot(aes(geometry = geometry)) +
  geom_sf(aes(fill = outcome_agg, col = outcome_agg, alpha = t),
          size = 0.1, # col = "grey80"
          ) +
  geom_sf_text(aes(label = id),
               size = 2.5, family = "Roboto Mono") +
  geom_sf(data = bland_shape,
          aes(geometry = geometry, 
              group = bundesland_de),
          fill = NA, col = "grey96",
          size = 2, show.legend = FALSE) +
  geom_sf(aes(col = outcome_agg),
          size = 0.1, fill = "transparent"
          ) +
  # geom_sf_label(data = df_constituencies_highlight_hex,
  #            aes(lon, lat, label = name_short),
  #            col = "grey99",
  #            fill = "grey10", alpha = 0.4, family = "Roboto",
  #            label.size = 0,
  #            fontface = "bold", size = 6,
  #            hjust = 0.5) +
  #scale_x_continuous(limits = c(NA, )) +
  scale_y_continuous(expand = c(.01, .01)) +
  scale_color_manual(values = c(party_colors, c("Kopf-an-Kopf" = "grey85")), name = NULL) +
  scale_fill_manual(values = c(party_colors, c("Kopf-an-Kopf" = "transparent")), name = NULL) +
  scale_alpha(range = c(0, .86), guide = "none") +
  guides(fill = guide_legend(override.aes = list(size = 0.25, alpha = .5))) +
  theme(legend.position = c(.08, .15),
        legend.key.size = unit(5, "mm"))

## Deutsche Version
g + labs(title = title_de, 
         subtitle = "Je intensiver die Färbung, desto größer ist der vorhergesagte Vorsprung.",
         caption = glue("{caption_de}\nTilegram-Geometrie: pitchinteractiveinc.github.io"))

ggsave(here::here("plots", "hexagon_map_t_test_de.pdf"), width = 10, height = 13, device = cairo_pdf)

## Englische Version
g + labs(title = title_en, 
         subtitle = "The more intense the coloring of the dots, the greater the predicted lead.",
         caption = glue("{caption_en}\nTilegram-Geometrie: pitchinteractiveinc.github.io")) +
  scale_color_manual(values = c(party_colors, c("Kopf-an-Kopf" = "grey85")),
                     name = NULL, labels = parties_en) +
  scale_fill_manual(values = c(party_colors, c("Kopf-an-Kopf" = "grey85")),
                    name = NULL, labels = parties_en)

ggsave(here::here("plots", "hexagon_map_t_test_en.pdf"), width = 10, height = 13, device = cairo_pdf)
``` 


```{r convert}
pdfs <- list.files(here::here(), pattern = "*.pdf", recursive = TRUE)
for(pdf in pdfs) {
  pdf_convert(pdf = glue::glue("{here::here()}/{pdf}"), 
              filenames = glue::glue("{here::here()}/{str_remove(pdf, '.pdf')}.png"),
              format = "png", dpi = 500)
}
```



***

<details><summary>Session Info</summary>

```{r sessionInfo}
Sys.time()
sessionInfo()
```

</details>
