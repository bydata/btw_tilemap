---
title: "Vorhersage Kandidaten Bundestagswahl 2021" 
description: ""
author:
    - name: "Cédric Scherer"
      url: https://cedricscherer.com
    - name: "Ansgar Wolsing"
      url: 
date: "`r Sys.Date()`"
output: 
    distill::distill_article:
        highlight: kate
        code_folding: false  
        toc: true            
        toc_depth: 2         
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = TRUE, message = TRUE,
                      fig.width = 10, fig.height = 13, 
                      dev = "ragg_png", res = 1000, retina = 1)
```

# Setup

```{r prep}
pacman::p_load("tidyverse", "here", "glue", "colorspace", "gsheet", "labelled")
```


# Daten

## Tile Map

```{r grid-constituencies}
## csv mit nur Wahlkreisen, für Tile Map
#write_csv(dat_erst_winneronly_dw %>% dplyr::select(Wahlkreisname), here::here("data", "wk.csv"))

## Grid Preparation für Labels und Bundesländer
# grid <- 
#   read_csv(here::here("data", "wk_grid_b.csv")) %>% 
#   mutate(
#     id = str_sub(Wahlkreisname, 1, 3),
#     id_num = as.numeric(id),
#     wk = str_sub(Wahlkreisname, 5, nchar(Wahlkreisname)),
#     land = case_when(
#       id_num %in% 1:11 ~ "Schleswig-Holstein",
#       id_num %in% 12:17 ~ "Mecklenburg-Vorpommern",
#       id_num %in% 18:23 ~ "Hamburg",
#       id_num %in% 24:53 ~ "Niedersachsen",
#       id_num %in% 54:55 ~ "Bremen",
#       id_num %in% 56:65 ~ "Brandenburg",
#       id_num %in% 66:74 ~ "Sachsen-Anhalt",
#       id_num %in% 75:86 ~ "Berlin",
#       id_num %in% 87:150 ~ "Nordrhein-Westfalen",
#       id_num %in% 151:166 ~ "Sachsen",
#       id_num %in% 167:188 ~ "Hessen",
#       id_num %in% 189:196 ~ "Thüringen",
#       id_num %in% 197:211 ~ "Rheinland-Pfalz",
#       id_num %in% 212:257 ~ "Bayern",
#       id_num %in% 258:295 ~ "Baden-Württemberg",
#       id_num %in% 296:299 ~ "Saarland"
#     )
#   )
# 
# write_csv(grid, here::here("data", "de_constituencies_grid_b.csv"))

grid <- read_csv(here::here("data", "de_constituencies_grid_b.csv"))
```


## Vorhersage der Direktmandatsgewinner*innen 2021

Source: Kayser, Leininger, Murr & Stötzer (2021) Citizens’ Forecast for the 2021 German National Election
https://aleininger.eu/citizens_forecast2021/

```{r data-prediction}
sheet_url <- "https://docs.google.com/spreadsheets/d/1xOg9kNRMfmUXoJAYNp7R93UHfPlVus-2VV-i-Rdx1Uc/edit#gid=0"
dat_erst <- gsheet2tbl(sheet_url)
#dat_erst <- read_csv(here::here("data", "Buerger_innenvorhersage 2021 - Prognose.csv"))

dat_erst_winneronly_dw <- 
  dat_erst %>%
  group_by(wkr) %>%
  dplyr::select(wkr, Wahlkreisname, party, kandidate_name, obs, Gewinner_share) %>%
  mutate(Gewinner_share = ifelse(Gewinner_share > 100, Gewinner_share / 1000, Gewinner_share),
         rank = rank(Gewinner_share, ties.method = "first"),
         name = to_character(wkr),
         Gewinner_share = round(Gewinner_share*100))  %>%
  filter(rank > 5) %>%
  mutate(party = as.character(party)) %>%
  unite(val, party, Gewinner_share, kandidate_name) %>%
  spread(rank,val) %>%
  separate("7",into = c("first-place-party", "first-place-votes", "winner"),"_") %>%
  separate("6",into = c("second-place-party", "second-place-votes", "second"),"_") %>%
  mutate(outcome = ifelse(`first-place-votes` == `second-place-votes`, 'Kopf-an-Kopf', `first-place-party`)) %>%
  relocate("outcome", "first-place-party", "first-place-votes", "winner", .before = "second-place-party") %>% 
  ungroup()
```

## Kombinierte Datensätze

```{r data-join}
dat_winneronly_grid <- 
  dat_erst_winneronly_dw %>% 
  left_join(grid) %>% 
  mutate(
    outcome_agg = ifelse(outcome %in% c("CDU", "CSU"), "CDU/CSU", outcome),
    diff = as.numeric(`first-place-votes`) - as.numeric(`second-place-votes`)
  )
```


# Visualisierungen

## Setup

```{r}
theme_set(theme_void(base_size = 16, base_family = "Editorial New"))
theme_update(legend.margin = margin(0, 0, 0, 25),
             legend.text = element_text(margin = margin(5, 0, 5, 0)),
             plot.title = element_text(hjust = .5, face = "bold", 
                                       lineheight = 1.1, margin = margin(t = 10, b = 20)),
             plot.subtitle = element_text(hjust = .5, color = "grey40", size = 15,
                                          margin = margin(t = -8, b = 18)),
             plot.title.position = "plot",
             plot.caption = element_text(hjust = 0, color = "grey40", 
                                         lineheight = 1.3,
                                         size = 10, margin = margin(20, 0, 5, 0)),
             plot.caption.position = "plot",
             plot.margin = margin(10, 0, 10, 0))

# Party colors
party_colors <- c("CDU/CSU" = "grey9",
                  #"CSU" = "grey18",
                  "SPD" = "#ca0002", ## "#E3000F",  a bit darker now to make it work with CVD
                  "AfD" = rgb(0, 158, 224, maxColorValue = 255),
                  "FDP" = darken("#ffed00", 0.1),
                  "Linke" = "purple",
                  "Grüne" = rgb(100, 161, 45, maxColorValue = 255))

caption <- "Grafik: Cédric Scherer & Ansgar Wolsing\nDaten: Kayser, Leininger, Murr & Stötzer (2021) Citizens’ Forecast for the 2021 German National Election (aleininger.eu/citizens_forecast2021)"
title <- "Bürger*innenvorhersage der Direktmandatsgewinner*innen\nin den Wahlkreisen zur Bundestagswahl 2021"
```


## Bubble Map

```{r bubble-map}
ggplot(dat_winneronly_grid, aes(col, row)) +
  geom_point(aes(color = outcome_agg), size = 10) +
  coord_fixed() +
  scale_x_continuous(limits = c(-.5, max(grid$col) + 2)) +
  scale_y_reverse() +
  scale_color_manual(values = c(party_colors, c("Kopf-an-Kopf" = "grey85")),
                     name = NULL) +
  guides(color = guide_legend(override.aes = list(size = 6))) +
  theme(legend.position = c(.87, .25)) +
  labs(title = title, caption = caption)

ggsave(here::here("plots", "bubble_map.pdf"), width = 10, height = 13, device = cairo_pdf)
```


### Variante mit gedämpfteren Farben für die Füllung der Punkte

```{r variant-lighter-fill}
ggplot(dat_winneronly_grid, aes(col, row)) +
  geom_point(
    aes(fill = outcome_agg), 
    size = 10, shape = 21, stroke = 2, alpha = .5, color = "transparent"
  ) +
  geom_point(
    aes(color = outcome_agg), 
    size = 10, shape = 21, stroke = 2, fill = "transparent"
  ) +
  coord_fixed() +
  scale_x_continuous(limits = c(-.5, max(grid$col) + 2)) +
  scale_y_reverse() +
  scale_color_manual(values = c(party_colors, c("Kopf-an-Kopf" = "grey85")), name = NULL) +
  scale_fill_manual(values = c(party_colors, c("Kopf-an-Kopf" = "grey85")), name = NULL) +
  guides(color = guide_legend(override.aes = list(size = 6))) +
  theme(legend.position = c(.87, .25)) +
  labs(title = title, caption = caption)

ggsave(here::here("plots", "bubble_map_var.pdf"), width = 10, height = 13, device = cairo_pdf)
```


## Bubble Map inkl. Vorsprung als Farbintensität

```{r variant-vorsprung}
ggplot(dat_winneronly_grid, aes(col, row)) +
  geom_point(
    aes(fill = outcome_agg, alpha = diff), 
    size = 9, shape = 21, stroke = 2, color = "transparent"
  ) +
  geom_point(
    aes(color = outcome_agg), 
    size = 9, shape = 21, stroke = 2, fill = "transparent"
  ) +
  coord_fixed() +
  scale_x_continuous(limits = c(-.5, max(grid$col) + 2)) +
  scale_y_reverse() +
  scale_color_manual(values = c(party_colors, c("Kopf-an-Kopf" = "grey85")), name = NULL) +
  scale_fill_manual(values = c(party_colors, c("Kopf-an-Kopf" = "transparent")), name = NULL) +
  scale_alpha(range = c(0, .86), guide = "none") +
  guides(fill = guide_legend(override.aes = list(size = 6, alpha = .9))) +
  theme(legend.position = c(.87, .25)) +
  labs(title = title, caption = caption,
       subtitle = "Je intensiver die Färbung, desto größer ist der vorhergesagte Vorsprung.")

ggsave(here::here("plots", "bubble_map_diff.pdf"), width = 10, height = 13, device = cairo_pdf)
```


## Bubble Map inkl. Grenzen der Bundesländer (trial)

```{r variant-states-ggforce}
ggplot(dat_winneronly_grid, aes(col, row)) +
  ggforce::geom_mark_hull(
    aes(group = land), 
    color = "white",
    expand = unit(0, "mm")
  ) +
  geom_point(aes(color = outcome_agg), size = 7) +
  coord_fixed() +
  scale_x_continuous(limits = c(-.5, max(grid$col) + 2)) +
  scale_y_reverse() +
  scale_color_manual(values = c(party_colors, c("Kopf-an-Kopf" = "grey85")),
                     name = NULL) +
  guides(color = guide_legend(override.aes = list(size = 6))) +
  theme(legend.position = c(.87, .25),
        plot.background = element_rect(color = "grey67", fill = "grey67")) +
  labs(title = title, caption = caption)

ggsave(here::here("plots", "bubble_map_states.pdf"), width = 10, height = 13, device = cairo_pdf)
```

## Interaktive Verison via {ggiraph}

```{r, interactive-version}
library(ggiraph)

g_interactive <- dat_winneronly_grid %>% 
  mutate(label = str_wrap(glue::glue("{Wahlkreisname} ({land})<br><br>Vorsprung:<br>{outcome} {diff}%"), 50)) %>% 
  ggplot(aes(col, row)) +
  geom_point_interactive(
    aes(fill = outcome_agg, alpha = diff, tooltip = label, data_id = label), 
    size = 9, shape = 21, stroke = 2, color = "transparent"
  ) +
  geom_point(
    aes(color = outcome_agg), 
    size = 9, shape = 21, stroke = 2, fill = "transparent"
  ) +
  coord_fixed() +
  scale_x_continuous(limits = c(-.5, max(grid$col) + 2)) +
  scale_y_reverse() +
  scale_color_manual(values = c(party_colors, c("Kopf-an-Kopf" = "grey85")), name = NULL) +
  scale_fill_manual(values = c(party_colors, c("Kopf-an-Kopf" = "transparent")), name = NULL) +
  scale_alpha(range = c(0, .86), guide = "none") +
  guides(color = guide_legend(override.aes = list(size = 6)))

tooltip_css <- "background-color:#515151;color:white;font-family:roboto;padding:10px;border-radius:5px;"

girafe(ggobj = g_interactive, 
       width_svg = 12, height_svg = 12, 
       options = list(
         opts_sizing(rescale = FALSE),
         opts_tooltip(offx = 50, css = tooltip_css)
       ))
#ggsave(here::here("plots", "bubble_map_states.pdf"), width = 10, height = 13, device = cairo_pdf)
```

***

<details><summary>Session Info</summary>

```{r sessionInfo}
## DO NOT REMOVE!
Sys.time()
#git2r::repository() ## uncomment if you are using GitHub
sessionInfo()
```

</details>
